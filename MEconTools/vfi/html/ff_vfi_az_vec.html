
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>FF_VFI_AZ_VEC (vectorized grid choice) Dynamic Savings Problem</title><meta name="generator" content="MATLAB 9.7"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2020-07-24"><meta name="DC.source" content="ff_vfi_az_vec.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>FF_VFI_AZ_VEC (vectorized grid choice) Dynamic Savings Problem</h1><!--introduction--><pre>  Vectorized faster solution for solving the dynamic programming problem
  with fixed assets grid using value function iteration. Obtains policy
  and value functions. Shock is AR(1). This function is vectorized, and
  generally fairly efficient in memory usage.</pre><pre>  * MP_PARAMS controls model preference, prices, shock and asset grid
  parameters.
  * MP_SUPPORT controls convergence criterion, printing and summary
  controls</pre><pre>  mp_params = containers.Map('KeyType','char', 'ValueType','any');
  mp_params('fl_crra') = 1.5;
  mp_params('fl_beta') = 0.95;
  mp_params('fl_w') = 1.05;
  mp_params('fl_r') = 0.03;
  mp_params('fl_a_min') = 0;
  mp_params('fl_a_max') = 50;
  mp_params('it_a_n') = 25;
  mp_params('st_grid_type') = 'grid_powerspace';
  mp_params('fl_z_persist') = 0.60;
  mp_params('fl_shk_std') = 0.10;
  mp_params('it_z_n') = 5;
  mp_params('st_grid_type') = 'grid_powerspace';</pre><pre>  mp_support = containers.Map('KeyType','char', 'ValueType','any');
  mp_support('fl_lowestc') = -10e10;
  mp_support('it_maxiter_val') = 500;
  mp_support('fl_tol_val') = 10e-5;
  % printer various information
  mp_support('bl_timer') = true;
  mp_support('bl_print_params') = false;
  mp_support('bl_print_iterinfo') = false;
  % These names must match keys of mp_solu: v=value, ap=savings choice,
  c=consumption, y=income, coh=cash-on-hand (income + savings),
  savefraccoh = ap/coh.
  % what outcomes to store in the mp_solu for export
  mp_support('ls_slout') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'};
  % outcome for ff_container_map_display
  mp_support('ls_ffcmd') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'};
  % outcome for ff_summ_nd_array
  mp_support('ls_ffsna') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'};
  % outcome for ff_graph_grid
  mp_support('ls_ffgrh') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'};
  % outcome for ff_summ_nd_array
  mp_support('ffsna_opt_it_row_n_keep') = 10;
  % outcome for ff_summ_nd_array
  mp_support('ffsna_opt_it_col_n_keep') = 9;</pre><pre>  [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC() default savings and shock
  model simulation</pre><pre>  [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC(MP_PARAMS) change model
  parameters through MP_PARAMS</pre><pre>  [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC(MP_PARAMS, MP_SUPPORT) change
  various printing, storaging, graphing, convergence etc controls
  through MP_SUPPORT</pre><pre>  [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC(MP_PARAMS, MP_SUPPORT,
  MP_SUPPORT_GRAPH) also changing graphing options, see the
  FF_GRAPH_GRID function for what key value paris can be specified.</pre><pre>  see also FX_VFI_AZ_VEC, FF_VFI_AZ_LOOP, FF_VFI_AZ_BISEC_LOOP,
  FF_VFI_AZ_BISEC_VEC, FF_VFI_AZ_MZOOM_LOOP, FF_VFI_AZ_MZOOM_VEC,
  FF_GRAPH_GRID</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#3">Set Default and Parse Inputs</a></li><li><a href="#4">Default Model Parameters</a></li><li><a href="#5">Parse mp_params</a></li><li><a href="#6">Generate A and Z Grids</a></li><li><a href="#7">Default Support Parameters</a></li><li><a href="#8">Whether Additional Outcomes Should be Stored</a></li><li><a href="#9">Initialize Matrix</a></li><li><a href="#10">Define Functions</a></li><li><a href="#11">Iterate and Dynamically Solve</a></li><li><a href="#12">Convergence Results</a></li><li><a href="#13">Results for Printing, and Graphing</a></li><li><a href="#14">Print Parameter Information</a></li><li><a href="#15">Show Value Function Convergence Information</a></li><li><a href="#16">ls_ffcmd summary</a></li><li><a href="#17">ls_ffsna summarize full</a></li><li><a href="#18">ls_ffgrh graph</a></li><li><a href="#19">Store Results for Output</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [mp_valpol_out, flag] = ff_vfi_az_vec(varargin)
</pre><h2 id="3">Set Default and Parse Inputs</h2><pre class="codeinput"><span class="keyword">if</span> (~isempty(varargin))

    <span class="keyword">if</span> (length(varargin) == 1)
        [mp_params_ext] = varargin{:};
    <span class="keyword">elseif</span> (length(varargin) == 2)
        [mp_params_ext, mp_support_ext] = varargin{:};
    <span class="keyword">end</span>

<span class="keyword">else</span>
    close <span class="string">all</span>

    mp_support_ext = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
    mp_support_ext(<span class="string">'bl_timer'</span>) = true;
    mp_support_ext(<span class="string">'bl_print_params'</span>) = true;
    mp_support_ext(<span class="string">'bl_print_iterinfo'</span>) = true;
    mp_support_ext(<span class="string">'ls_ffcmd'</span>) = {<span class="string">'v'</span>, <span class="string">'ap'</span>, <span class="string">'c'</span>, <span class="string">'y'</span>, <span class="string">'coh'</span>, <span class="string">'savefraccoh'</span>};
    mp_support_ext(<span class="string">'ls_ffsna'</span>) = {<span class="string">'ap'</span>};
    mp_support_ext(<span class="string">'ls_ffgrh'</span>) = {<span class="string">'v'</span>, <span class="string">'ap'</span>, <span class="string">'c'</span>, <span class="string">'y'</span>, <span class="string">'savefraccoh'</span>};
    mp_support_ext(<span class="string">'ls_store'</span>) = {<span class="string">'v'</span>, <span class="string">'ap'</span>, <span class="string">'c'</span>, <span class="string">'y'</span>, <span class="string">'coh'</span>};
    mp_support_ext(<span class="string">'ffsna_opt_it_row_n_keep'</span>) = 10;
    mp_support_ext(<span class="string">'ffsna_opt_it_col_n_keep'</span>) = 9;

<span class="keyword">end</span>
</pre><h2 id="4">Default Model Parameters</h2><p>support_map</p><pre class="codeinput">mp_params = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
mp_params(<span class="string">'fl_crra'</span>) = 1.5;
mp_params(<span class="string">'fl_beta'</span>) = 0.95;

mp_params(<span class="string">'fl_w'</span>) = 1.40;
mp_params(<span class="string">'fl_r'</span>) = 0.04;

mp_params(<span class="string">'fl_a_min'</span>) = 0;
mp_params(<span class="string">'fl_a_max'</span>) = 50;
mp_params(<span class="string">'it_a_n'</span>) = 100;
mp_params(<span class="string">'st_grid_type'</span>) = <span class="string">'grid_powerspace'</span>;

mp_params(<span class="string">'fl_z_persist'</span>) = 0.80;
mp_params(<span class="string">'fl_shk_std'</span>) = 0.20;
mp_params(<span class="string">'it_z_n'</span>) = 7;

<span class="comment">% override default support_map values</span>
<span class="keyword">if</span> (length(varargin)&gt;=1)
    mp_params = [mp_params; mp_params_ext];
<span class="keyword">end</span>
</pre><h2 id="5">Parse mp_params</h2><pre class="codeinput">params_group = values(mp_params, {<span class="string">'fl_crra'</span>, <span class="string">'fl_beta'</span>});
[fl_crra, fl_beta] = params_group{:};
params_group = values(mp_params, {<span class="string">'fl_w'</span>, <span class="string">'fl_r'</span>});
[fl_w, fl_r] = params_group{:};
params_group = values(mp_params, {<span class="string">'fl_a_min'</span>, <span class="string">'fl_a_max'</span>, <span class="string">'it_a_n'</span>, <span class="string">'st_grid_type'</span>});
[fl_a_min, fl_a_max, it_a_n, st_grid_type] = params_group{:};
params_group = values(mp_params, {<span class="string">'fl_z_persist'</span>, <span class="string">'fl_shk_std'</span>, <span class="string">'it_z_n'</span>});
[fl_z_persist, fl_shk_std, it_z_n] = params_group{:};
</pre><h2 id="6">Generate A and Z Grids</h2><p>Same min and max and grid points</p><pre class="codeinput">[ar_a] = ff_saveborr_grid(fl_a_min, fl_a_max, it_a_n, st_grid_type);
ar_a = ar_a';

<span class="comment">% shock vector and transition, normalize mean exp(shk) to 1</span>
[ar_z, mt_z_trans] = ffy_rouwenhorst(fl_z_persist, fl_shk_std, it_z_n, false);
<span class="comment">% [ar_z, mt_z_trans] = ffy_tauchen(fl_z_persist, fl_shk_std, it_z_n, false);</span>
<span class="comment">% normalize mean of exp to 1, fl_shk_std does not shift mean.</span>
ar_z_stationary = mt_z_trans^1000;
ar_z_stationary = ar_z_stationary(1,:);
fl_labor_agg = ar_z_stationary*exp(ar_z);
ar_z = exp(ar_z')/fl_labor_agg;
</pre><h2 id="7">Default Support Parameters</h2><p>support_map</p><pre class="codeinput">mp_support = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);

<span class="comment">% Model Control</span>
mp_support(<span class="string">'fl_lowestc'</span>) = -1e10;

<span class="comment">% Iteration Control</span>
mp_support(<span class="string">'it_maxiter_val'</span>) = 500;
mp_support(<span class="string">'fl_tol_val'</span>) = 1e-5;

<span class="comment">% printer various information</span>
mp_support(<span class="string">'bl_timer'</span>) = true;
mp_support(<span class="string">'bl_print_params'</span>) = false;
mp_support(<span class="string">'bl_print_iterinfo'</span>) = false;

<span class="comment">% These names must match keys of mp_solu: v, ap, c, y, savefraccoh</span>
<span class="comment">% what outcomes to store in the mp_solu for export</span>
mp_support(<span class="string">'ls_slout'</span>) = {<span class="string">'v'</span>, <span class="string">'ap'</span>, <span class="string">'c'</span>, <span class="string">'y'</span>, <span class="string">'coh'</span>, <span class="string">'savefraccoh'</span>};
<span class="comment">% outcome for ff_container_map_display</span>
mp_support(<span class="string">'ls_ffcmd'</span>) = {<span class="string">'ap'</span>};
<span class="comment">% outcome for ff_summ_nd_array</span>
mp_support(<span class="string">'ls_ffsna'</span>) = {};
<span class="comment">% outcome for ff_graph_grid</span>
mp_support(<span class="string">'ls_ffgrh'</span>) = {};
<span class="comment">% outcome for ff_summ_nd_array</span>
mp_support(<span class="string">'ffsna_opt_it_row_n_keep'</span>) = 10;
<span class="comment">% outcome for ff_summ_nd_array</span>
mp_support(<span class="string">'ffsna_opt_it_col_n_keep'</span>) = 9;

<span class="comment">% override default support_map values</span>
<span class="keyword">if</span> (length(varargin)&gt;=2 || isempty(varargin))
    mp_support = [mp_support; mp_support_ext];
<span class="keyword">end</span>

<span class="comment">% Parse mp_support</span>
params_group = values(mp_support, {<span class="string">'fl_lowestc'</span>});
[fl_lowestc] = params_group{:};
params_group = values(mp_support, {<span class="string">'it_maxiter_val'</span>, <span class="string">'fl_tol_val'</span>});
[it_maxiter_val, fl_tol_val] = params_group{:};
params_group = values(mp_support, {<span class="string">'bl_timer'</span>, <span class="string">'bl_print_params'</span>, <span class="string">'bl_print_iterinfo'</span>});
[bl_timer, bl_print_params, bl_print_iterinfo] = params_group{:};
params_group = values(mp_support, <span class="keyword">...</span>
    {<span class="string">'ls_slout'</span>, <span class="string">'ls_ffcmd'</span>, <span class="string">'ls_ffsna'</span>, <span class="string">'ls_ffgrh'</span>,<span class="keyword">...</span>
    <span class="string">'ffsna_opt_it_row_n_keep'</span>, <span class="string">'ffsna_opt_it_col_n_keep'</span>});
[ls_slout, ls_ffcmd, ls_ffsna, ls_ffgrh,<span class="keyword">...</span>
    ffsna_opt_it_row_n_keep, ffsna_opt_it_col_n_keep] = params_group{:};
</pre><h2 id="8">Whether Additional Outcomes Should be Stored</h2><p>when state space are large, might not be a good idea to store all possible model output matrixes, but could be controlled with these if things should be outputed. If bl_store_more = true, will output store all additional possible outcomes if bl_vfi_store_all = true. Internally, which output becomes tabular or graphical controled by ls_ffcmd, ls_ffsna, and ls_ffgrh.</p><pre class="codeinput"><span class="comment">% If to store additional outcomes</span>
cl_more = {<span class="string">'c'</span>, <span class="string">'y'</span>, <span class="string">'coh'</span>, <span class="string">'savefraccoh'</span>};
ar_find_slout = cell2mat(cellfun(@(m) find(strcmp(ls_slout, m)), cl_more, <span class="string">'UniformOutput'</span>, false));
ar_find_ffcmd = cell2mat(cellfun(@(m) find(strcmp(ls_ffcmd, m)), cl_more, <span class="string">'UniformOutput'</span>, false));
ar_find_ffsna = cell2mat(cellfun(@(m) find(strcmp(ls_ffsna, m)), cl_more, <span class="string">'UniformOutput'</span>, false));
ar_find_ffgrh = cell2mat(cellfun(@(m) find(strcmp(ls_ffgrh, m)), cl_more, <span class="string">'UniformOutput'</span>, false));
bl_store_more = false;
<span class="keyword">if</span> (length(ar_find_slout) + length(ar_find_ffcmd) + length(ar_find_ffsna) + length(ar_find_ffgrh) &gt;1)
    bl_store_more = true;
<span class="keyword">end</span>
</pre><h2 id="9">Initialize Matrix</h2><pre class="codeinput">mt_val_cur = zeros(length(ar_a),length(ar_z));
mt_val_lst = mt_val_cur;
mt_aprime_cur = zeros(length(ar_a),length(ar_z));
mt_aprime_lst = mt_aprime_cur;
mt_aprime_idx = zeros(length(ar_a),length(ar_z));
ar_val_diff_norm = zeros([it_maxiter_val, 1]);
ar_pol_diff_norm = zeros([it_maxiter_val, 1]);
mt_pol_perc_change = zeros([it_maxiter_val, length(ar_z)]);

<span class="keyword">if</span> (bl_store_more)
    mt_c = zeros(length(ar_a),length(ar_z));
    mt_y = zeros(length(ar_a),length(ar_z));
    mt_coh = zeros(length(ar_a),length(ar_z));
<span class="keyword">end</span>
</pre><h2 id="10">Define Functions</h2><pre class="codeinput">f_util_log = @(c) log(c);
f_util_crra = @(c) (((c).^(1-fl_crra)-1)./(1-fl_crra));
f_y = @(z, b) (z*fl_w + b.*(fl_r));
f_coh = @(z, b) (z*fl_w + b.*(1+fl_r));
f_cons = @(z, b, bprime) (f_coh(z, b) - bprime);
</pre><h2 id="11">Iterate and Dynamically Solve</h2><pre class="codeinput"><span class="keyword">if</span> (bl_timer)
    tic
<span class="keyword">end</span>

<span class="comment">% initialize</span>
fl_diff = 1;
it_iter = 0;

<span class="comment">% After converge, one more iteration to store results</span>
bl_continue = true;
bl_converged = false;

<span class="keyword">while</span> bl_continue

    <span class="comment">% A. Loop over endo and exo states, solve for ap(a,z)</span>
    <span class="comment">% loop 1: over exogenous states</span>
    <span class="comment">% incorporating these shocks into vectorization has high memory burden</span>
    <span class="comment">% but insignificant speed gains. Keeping this loop allows for large</span>
    <span class="comment">% number of shocks without overwhelming memory</span>
    <span class="keyword">for</span> it_z_ctr = 1:length(ar_z)

        <span class="comment">% Current Shock</span>
        fl_z = ar_z(it_z_ctr);

        <span class="comment">% Consumption and u(c) only need to be evaluated once</span>
        <span class="keyword">if</span> (it_iter == 0)

            <span class="comment">% Consumption: fl_z = 1 by 1, ar_a = 1 by N, ar_a' = N by 1</span>
            <span class="comment">% mt_c is N by N: matrix broadcasting, expand to matrix from arrays</span>
            mt_c_a_ap = f_cons(fl_z, ar_a, ar_a');

            <span class="comment">% EVAL current utility: N by N, f_util defined earlier</span>
            <span class="comment">% slightly faster to explicitly write function</span>
            <span class="keyword">if</span> (fl_crra == 1)
                mt_utility = f_util_log(mt_c_a_ap);
            <span class="keyword">else</span>
                <span class="comment">% slightly faster if write function here directly, but</span>
                <span class="comment">% speed gain is very small, more important to have single</span>
                <span class="comment">% location control of functions.</span>
                mt_utility = f_util_crra(mt_c_a_ap);
            <span class="keyword">end</span>

            <span class="comment">% Eliminate Complex Numbers</span>
            mt_it_c_valid_idx = (mt_c_a_ap &lt;= 0);
            mt_utility(mt_it_c_valid_idx) = fl_lowestc;

            <span class="comment">% Store in cells</span>
            cl_u_c_store{it_z_ctr} = mt_utility;
            cl_c_valid_idx{it_z_ctr} = mt_it_c_valid_idx;

        <span class="keyword">end</span>

        <span class="comment">% f(z'|z), 1 by Z</span>
        ar_z_trans_condi = mt_z_trans(it_z_ctr,:);

        <span class="comment">% EVAL EV((A',K'),Z'|Z) = V((A',K'),Z') x p(z'|z)', (N by Z) x (Z by 1) = N by 1</span>
        <span class="comment">% Note: transpose ar_z_trans_condi from 1 by Z to Z by 1</span>
        <span class="comment">% Note: matrix multiply not dot multiply</span>
        mt_evzp_condi_z = mt_val_lst * ar_z_trans_condi';

        <span class="comment">% EVAL add on future utility, N by N + N by 1, broadcast again</span>
        mt_utility = cl_u_c_store{it_z_ctr} + fl_beta*mt_evzp_condi_z;

        <span class="comment">% Index update</span>
        <span class="comment">% using the method below is much faster than index replace</span>
        <span class="comment">% see &lt;https://fanwangecon.github.io/M4Econ/support/speed/index/fs_subscript.html fs_subscript&gt;</span>
        mt_it_c_valid_idx = cl_c_valid_idx{it_z_ctr};
        mt_utility = mt_utility.*(~mt_it_c_valid_idx) + (fl_lowestc)*(mt_it_c_valid_idx);

        <span class="comment">% Optimization: remember matlab is column major, rows must be</span>
        <span class="comment">% choices, columns must be states</span>
        <span class="comment">% &lt;https://en.wikipedia.org/wiki/Row-_and_column-major_order COLUMN-MAJOR&gt;</span>
        <span class="comment">% mt_utility is N by N, rows are choices, cols are states.</span>
        [ar_opti_val1_z, ar_opti_idx_z] = max(mt_utility);
        mt_val_cur(:,it_z_ctr) = ar_opti_val1_z';
        mt_aprime_cur(:,it_z_ctr) = ar_a(ar_opti_idx_z);

        <span class="comment">% Save Additional Results</span>
        <span class="keyword">if</span> bl_converged
            mt_aprime_idx(:,it_z_ctr) = ar_opti_idx_z;
            <span class="keyword">if</span> (bl_store_more)
                mt_c(:,it_z_ctr) = f_cons(fl_z, ar_a, ar_a(ar_opti_idx_z));
                mt_y(:,it_z_ctr) = f_y(fl_z, ar_a);
                mt_coh(:,it_z_ctr) = f_coh(fl_z, ar_a);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">% B. Various Continuous Conditions</span>
    <span class="comment">% Continuation Conditions:</span>
    it_iter = it_iter + 1;
    fl_diff = norm(mt_val_cur-mt_val_lst);
    diff_pol = norm(mt_aprime_cur-mt_aprime_lst);

    <span class="comment">% Difference across iterations</span>
    <span class="keyword">if</span> (bl_print_iterinfo)
        ar_val_diff_norm(it_iter) = fl_diff;
        ar_pol_diff_norm(it_iter) = diff_pol;
        mt_pol_perc_change(it_iter, :) = sum((mt_aprime_cur ~= mt_aprime_lst))/(length(ar_a));
    <span class="keyword">end</span>

    <span class="comment">% Update</span>
    mt_val_lst = mt_val_cur;
    mt_aprime_lst = mt_aprime_cur;

    <span class="comment">% Update Continue Criterion</span>
    <span class="keyword">if</span> bl_converged
        bl_continue = false;
    <span class="keyword">elseif</span>(fl_diff &lt;= fl_tol_val || it_iter &gt;= it_maxiter_val)
        bl_converged = true;
    <span class="keyword">end</span>

    <span class="comment">% C. Print Iteration Record</span>
    <span class="keyword">if</span>(bl_print_iterinfo)
        disp([<span class="string">'ff_vfi_az_bisec_loop, it_iter:'</span> num2str(it_iter) <span class="keyword">...</span>
            <span class="string">', fl_diff:'</span> num2str(fl_diff)]);
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><pre class="codeoutput">ff_vfi_az_bisec_loop, it_iter:1, fl_diff:34.289
ff_vfi_az_bisec_loop, it_iter:2, fl_diff:25.3225
ff_vfi_az_bisec_loop, it_iter:3, fl_diff:20.9288
ff_vfi_az_bisec_loop, it_iter:4, fl_diff:17.9361
ff_vfi_az_bisec_loop, it_iter:5, fl_diff:15.6881
ff_vfi_az_bisec_loop, it_iter:6, fl_diff:13.9099
ff_vfi_az_bisec_loop, it_iter:7, fl_diff:12.4557
ff_vfi_az_bisec_loop, it_iter:8, fl_diff:11.237
ff_vfi_az_bisec_loop, it_iter:9, fl_diff:10.1995
ff_vfi_az_bisec_loop, it_iter:10, fl_diff:9.3022
ff_vfi_az_bisec_loop, it_iter:11, fl_diff:8.5194
ff_vfi_az_bisec_loop, it_iter:12, fl_diff:7.8306
ff_vfi_az_bisec_loop, it_iter:13, fl_diff:7.2177
ff_vfi_az_bisec_loop, it_iter:14, fl_diff:6.6717
ff_vfi_az_bisec_loop, it_iter:15, fl_diff:6.184
ff_vfi_az_bisec_loop, it_iter:16, fl_diff:5.7438
ff_vfi_az_bisec_loop, it_iter:17, fl_diff:5.341
ff_vfi_az_bisec_loop, it_iter:18, fl_diff:4.9701
ff_vfi_az_bisec_loop, it_iter:19, fl_diff:4.6287
ff_vfi_az_bisec_loop, it_iter:20, fl_diff:4.3163
ff_vfi_az_bisec_loop, it_iter:21, fl_diff:4.0301
ff_vfi_az_bisec_loop, it_iter:22, fl_diff:3.7679
ff_vfi_az_bisec_loop, it_iter:23, fl_diff:3.5273
ff_vfi_az_bisec_loop, it_iter:24, fl_diff:3.3055
ff_vfi_az_bisec_loop, it_iter:25, fl_diff:3.1008
ff_vfi_az_bisec_loop, it_iter:26, fl_diff:2.9109
ff_vfi_az_bisec_loop, it_iter:27, fl_diff:2.7362
ff_vfi_az_bisec_loop, it_iter:28, fl_diff:2.5744
ff_vfi_az_bisec_loop, it_iter:29, fl_diff:2.4231
ff_vfi_az_bisec_loop, it_iter:30, fl_diff:2.2815
ff_vfi_az_bisec_loop, it_iter:31, fl_diff:2.1498
ff_vfi_az_bisec_loop, it_iter:32, fl_diff:2.0256
ff_vfi_az_bisec_loop, it_iter:33, fl_diff:1.9085
ff_vfi_az_bisec_loop, it_iter:34, fl_diff:1.7983
ff_vfi_az_bisec_loop, it_iter:35, fl_diff:1.6946
ff_vfi_az_bisec_loop, it_iter:36, fl_diff:1.5971
ff_vfi_az_bisec_loop, it_iter:37, fl_diff:1.5054
ff_vfi_az_bisec_loop, it_iter:38, fl_diff:1.4193
ff_vfi_az_bisec_loop, it_iter:39, fl_diff:1.3385
ff_vfi_az_bisec_loop, it_iter:40, fl_diff:1.2625
ff_vfi_az_bisec_loop, it_iter:41, fl_diff:1.1912
ff_vfi_az_bisec_loop, it_iter:42, fl_diff:1.1241
ff_vfi_az_bisec_loop, it_iter:43, fl_diff:1.0611
ff_vfi_az_bisec_loop, it_iter:44, fl_diff:1.002
ff_vfi_az_bisec_loop, it_iter:45, fl_diff:0.94638
ff_vfi_az_bisec_loop, it_iter:46, fl_diff:0.89412
ff_vfi_az_bisec_loop, it_iter:47, fl_diff:0.84489
ff_vfi_az_bisec_loop, it_iter:48, fl_diff:0.7985
ff_vfi_az_bisec_loop, it_iter:49, fl_diff:0.75475
ff_vfi_az_bisec_loop, it_iter:50, fl_diff:0.71346
ff_vfi_az_bisec_loop, it_iter:51, fl_diff:0.6745
ff_vfi_az_bisec_loop, it_iter:52, fl_diff:0.6377
ff_vfi_az_bisec_loop, it_iter:53, fl_diff:0.60297
ff_vfi_az_bisec_loop, it_iter:54, fl_diff:0.57016
ff_vfi_az_bisec_loop, it_iter:55, fl_diff:0.53917
ff_vfi_az_bisec_loop, it_iter:56, fl_diff:0.50992
ff_vfi_az_bisec_loop, it_iter:57, fl_diff:0.4823
ff_vfi_az_bisec_loop, it_iter:58, fl_diff:0.4562
ff_vfi_az_bisec_loop, it_iter:59, fl_diff:0.43154
ff_vfi_az_bisec_loop, it_iter:60, fl_diff:0.40825
ff_vfi_az_bisec_loop, it_iter:61, fl_diff:0.38625
ff_vfi_az_bisec_loop, it_iter:62, fl_diff:0.36545
ff_vfi_az_bisec_loop, it_iter:63, fl_diff:0.34581
ff_vfi_az_bisec_loop, it_iter:64, fl_diff:0.32724
ff_vfi_az_bisec_loop, it_iter:65, fl_diff:0.3097
ff_vfi_az_bisec_loop, it_iter:66, fl_diff:0.29313
ff_vfi_az_bisec_loop, it_iter:67, fl_diff:0.27746
ff_vfi_az_bisec_loop, it_iter:68, fl_diff:0.26265
ff_vfi_az_bisec_loop, it_iter:69, fl_diff:0.24866
ff_vfi_az_bisec_loop, it_iter:70, fl_diff:0.23542
ff_vfi_az_bisec_loop, it_iter:71, fl_diff:0.22292
ff_vfi_az_bisec_loop, it_iter:72, fl_diff:0.2111
ff_vfi_az_bisec_loop, it_iter:73, fl_diff:0.19992
ff_vfi_az_bisec_loop, it_iter:74, fl_diff:0.18935
ff_vfi_az_bisec_loop, it_iter:75, fl_diff:0.17935
ff_vfi_az_bisec_loop, it_iter:76, fl_diff:0.16989
ff_vfi_az_bisec_loop, it_iter:77, fl_diff:0.16094
ff_vfi_az_bisec_loop, it_iter:78, fl_diff:0.15248
ff_vfi_az_bisec_loop, it_iter:79, fl_diff:0.14447
ff_vfi_az_bisec_loop, it_iter:80, fl_diff:0.1369
ff_vfi_az_bisec_loop, it_iter:81, fl_diff:0.12974
ff_vfi_az_bisec_loop, it_iter:82, fl_diff:0.12295
ff_vfi_az_bisec_loop, it_iter:83, fl_diff:0.11654
ff_vfi_az_bisec_loop, it_iter:84, fl_diff:0.11046
ff_vfi_az_bisec_loop, it_iter:85, fl_diff:0.10471
ff_vfi_az_bisec_loop, it_iter:86, fl_diff:0.099265
ff_vfi_az_bisec_loop, it_iter:87, fl_diff:0.09411
ff_vfi_az_bisec_loop, it_iter:88, fl_diff:0.089228
ff_vfi_az_bisec_loop, it_iter:89, fl_diff:0.084606
ff_vfi_az_bisec_loop, it_iter:90, fl_diff:0.080229
ff_vfi_az_bisec_loop, it_iter:91, fl_diff:0.076083
ff_vfi_az_bisec_loop, it_iter:92, fl_diff:0.072155
ff_vfi_az_bisec_loop, it_iter:93, fl_diff:0.068435
ff_vfi_az_bisec_loop, it_iter:94, fl_diff:0.06491
ff_vfi_az_bisec_loop, it_iter:95, fl_diff:0.061571
ff_vfi_az_bisec_loop, it_iter:96, fl_diff:0.058406
ff_vfi_az_bisec_loop, it_iter:97, fl_diff:0.055408
ff_vfi_az_bisec_loop, it_iter:98, fl_diff:0.052566
ff_vfi_az_bisec_loop, it_iter:99, fl_diff:0.049872
ff_vfi_az_bisec_loop, it_iter:100, fl_diff:0.047319
ff_vfi_az_bisec_loop, it_iter:101, fl_diff:0.044899
ff_vfi_az_bisec_loop, it_iter:102, fl_diff:0.042604
ff_vfi_az_bisec_loop, it_iter:103, fl_diff:0.040429
ff_vfi_az_bisec_loop, it_iter:104, fl_diff:0.038366
ff_vfi_az_bisec_loop, it_iter:105, fl_diff:0.03641
ff_vfi_az_bisec_loop, it_iter:106, fl_diff:0.034556
ff_vfi_az_bisec_loop, it_iter:107, fl_diff:0.032797
ff_vfi_az_bisec_loop, it_iter:108, fl_diff:0.031129
ff_vfi_az_bisec_loop, it_iter:109, fl_diff:0.029546
ff_vfi_az_bisec_loop, it_iter:110, fl_diff:0.028046
ff_vfi_az_bisec_loop, it_iter:111, fl_diff:0.026622
ff_vfi_az_bisec_loop, it_iter:112, fl_diff:0.025271
ff_vfi_az_bisec_loop, it_iter:113, fl_diff:0.02399
ff_vfi_az_bisec_loop, it_iter:114, fl_diff:0.022774
ff_vfi_az_bisec_loop, it_iter:115, fl_diff:0.021621
ff_vfi_az_bisec_loop, it_iter:116, fl_diff:0.020527
ff_vfi_az_bisec_loop, it_iter:117, fl_diff:0.019488
ff_vfi_az_bisec_loop, it_iter:118, fl_diff:0.018503
ff_vfi_az_bisec_loop, it_iter:119, fl_diff:0.017567
ff_vfi_az_bisec_loop, it_iter:120, fl_diff:0.01668
ff_vfi_az_bisec_loop, it_iter:121, fl_diff:0.015838
ff_vfi_az_bisec_loop, it_iter:122, fl_diff:0.015038
ff_vfi_az_bisec_loop, it_iter:123, fl_diff:0.014279
ff_vfi_az_bisec_loop, it_iter:124, fl_diff:0.013559
ff_vfi_az_bisec_loop, it_iter:125, fl_diff:0.012876
ff_vfi_az_bisec_loop, it_iter:126, fl_diff:0.012227
ff_vfi_az_bisec_loop, it_iter:127, fl_diff:0.011611
ff_vfi_az_bisec_loop, it_iter:128, fl_diff:0.011026
ff_vfi_az_bisec_loop, it_iter:129, fl_diff:0.010471
ff_vfi_az_bisec_loop, it_iter:130, fl_diff:0.0099436
ff_vfi_az_bisec_loop, it_iter:131, fl_diff:0.0094432
ff_vfi_az_bisec_loop, it_iter:132, fl_diff:0.0089681
ff_vfi_az_bisec_loop, it_iter:133, fl_diff:0.0085171
ff_vfi_az_bisec_loop, it_iter:134, fl_diff:0.0080888
ff_vfi_az_bisec_loop, it_iter:135, fl_diff:0.0076822
ff_vfi_az_bisec_loop, it_iter:136, fl_diff:0.0072961
ff_vfi_az_bisec_loop, it_iter:137, fl_diff:0.0069295
ff_vfi_az_bisec_loop, it_iter:138, fl_diff:0.0065814
ff_vfi_az_bisec_loop, it_iter:139, fl_diff:0.0062508
ff_vfi_az_bisec_loop, it_iter:140, fl_diff:0.005937
ff_vfi_az_bisec_loop, it_iter:141, fl_diff:0.0056389
ff_vfi_az_bisec_loop, it_iter:142, fl_diff:0.0053558
ff_vfi_az_bisec_loop, it_iter:143, fl_diff:0.005087
ff_vfi_az_bisec_loop, it_iter:144, fl_diff:0.0048318
ff_vfi_az_bisec_loop, it_iter:145, fl_diff:0.0045894
ff_vfi_az_bisec_loop, it_iter:146, fl_diff:0.0043591
ff_vfi_az_bisec_loop, it_iter:147, fl_diff:0.0041405
ff_vfi_az_bisec_loop, it_iter:148, fl_diff:0.0039328
ff_vfi_az_bisec_loop, it_iter:149, fl_diff:0.0037356
ff_vfi_az_bisec_loop, it_iter:150, fl_diff:0.0035483
ff_vfi_az_bisec_loop, it_iter:151, fl_diff:0.0033705
ff_vfi_az_bisec_loop, it_iter:152, fl_diff:0.0032015
ff_vfi_az_bisec_loop, it_iter:153, fl_diff:0.0030411
ff_vfi_az_bisec_loop, it_iter:154, fl_diff:0.0028887
ff_vfi_az_bisec_loop, it_iter:155, fl_diff:0.0027439
ff_vfi_az_bisec_loop, it_iter:156, fl_diff:0.0026064
ff_vfi_az_bisec_loop, it_iter:157, fl_diff:0.0024758
ff_vfi_az_bisec_loop, it_iter:158, fl_diff:0.0023518
ff_vfi_az_bisec_loop, it_iter:159, fl_diff:0.002234
ff_vfi_az_bisec_loop, it_iter:160, fl_diff:0.0021221
ff_vfi_az_bisec_loop, it_iter:161, fl_diff:0.0020158
ff_vfi_az_bisec_loop, it_iter:162, fl_diff:0.0019149
ff_vfi_az_bisec_loop, it_iter:163, fl_diff:0.001819
ff_vfi_az_bisec_loop, it_iter:164, fl_diff:0.0017279
ff_vfi_az_bisec_loop, it_iter:165, fl_diff:0.0016414
ff_vfi_az_bisec_loop, it_iter:166, fl_diff:0.0015592
ff_vfi_az_bisec_loop, it_iter:167, fl_diff:0.0014812
ff_vfi_az_bisec_loop, it_iter:168, fl_diff:0.001407
ff_vfi_az_bisec_loop, it_iter:169, fl_diff:0.0013366
ff_vfi_az_bisec_loop, it_iter:170, fl_diff:0.0012697
ff_vfi_az_bisec_loop, it_iter:171, fl_diff:0.0012061
ff_vfi_az_bisec_loop, it_iter:172, fl_diff:0.0011458
ff_vfi_az_bisec_loop, it_iter:173, fl_diff:0.0010884
ff_vfi_az_bisec_loop, it_iter:174, fl_diff:0.001034
ff_vfi_az_bisec_loop, it_iter:175, fl_diff:0.00098221
ff_vfi_az_bisec_loop, it_iter:176, fl_diff:0.00093306
ff_vfi_az_bisec_loop, it_iter:177, fl_diff:0.00088637
ff_vfi_az_bisec_loop, it_iter:178, fl_diff:0.00084201
ff_vfi_az_bisec_loop, it_iter:179, fl_diff:0.00079988
ff_vfi_az_bisec_loop, it_iter:180, fl_diff:0.00075986
ff_vfi_az_bisec_loop, it_iter:181, fl_diff:0.00072184
ff_vfi_az_bisec_loop, it_iter:182, fl_diff:0.00068573
ff_vfi_az_bisec_loop, it_iter:183, fl_diff:0.00065142
ff_vfi_az_bisec_loop, it_iter:184, fl_diff:0.00061883
ff_vfi_az_bisec_loop, it_iter:185, fl_diff:0.00058787
ff_vfi_az_bisec_loop, it_iter:186, fl_diff:0.00055846
ff_vfi_az_bisec_loop, it_iter:187, fl_diff:0.00053053
ff_vfi_az_bisec_loop, it_iter:188, fl_diff:0.00050399
ff_vfi_az_bisec_loop, it_iter:189, fl_diff:0.00047878
ff_vfi_az_bisec_loop, it_iter:190, fl_diff:0.00045483
ff_vfi_az_bisec_loop, it_iter:191, fl_diff:0.00043208
ff_vfi_az_bisec_loop, it_iter:192, fl_diff:0.00041046
ff_vfi_az_bisec_loop, it_iter:193, fl_diff:0.00038993
ff_vfi_az_bisec_loop, it_iter:194, fl_diff:0.00037043
ff_vfi_az_bisec_loop, it_iter:195, fl_diff:0.0003519
ff_vfi_az_bisec_loop, it_iter:196, fl_diff:0.0003343
ff_vfi_az_bisec_loop, it_iter:197, fl_diff:0.00031758
ff_vfi_az_bisec_loop, it_iter:198, fl_diff:0.0003017
ff_vfi_az_bisec_loop, it_iter:199, fl_diff:0.00028661
ff_vfi_az_bisec_loop, it_iter:200, fl_diff:0.00027227
ff_vfi_az_bisec_loop, it_iter:201, fl_diff:0.00025866
ff_vfi_az_bisec_loop, it_iter:202, fl_diff:0.00024572
ff_vfi_az_bisec_loop, it_iter:203, fl_diff:0.00023343
ff_vfi_az_bisec_loop, it_iter:204, fl_diff:0.00022176
ff_vfi_az_bisec_loop, it_iter:205, fl_diff:0.00021067
ff_vfi_az_bisec_loop, it_iter:206, fl_diff:0.00020013
ff_vfi_az_bisec_loop, it_iter:207, fl_diff:0.00019012
ff_vfi_az_bisec_loop, it_iter:208, fl_diff:0.00018061
ff_vfi_az_bisec_loop, it_iter:209, fl_diff:0.00017158
ff_vfi_az_bisec_loop, it_iter:210, fl_diff:0.000163
ff_vfi_az_bisec_loop, it_iter:211, fl_diff:0.00015485
ff_vfi_az_bisec_loop, it_iter:212, fl_diff:0.00014711
ff_vfi_az_bisec_loop, it_iter:213, fl_diff:0.00013975
ff_vfi_az_bisec_loop, it_iter:214, fl_diff:0.00013276
ff_vfi_az_bisec_loop, it_iter:215, fl_diff:0.00012612
ff_vfi_az_bisec_loop, it_iter:216, fl_diff:0.00011982
ff_vfi_az_bisec_loop, it_iter:217, fl_diff:0.00011382
ff_vfi_az_bisec_loop, it_iter:218, fl_diff:0.00010813
ff_vfi_az_bisec_loop, it_iter:219, fl_diff:0.00010272
ff_vfi_az_bisec_loop, it_iter:220, fl_diff:9.7588e-05
ff_vfi_az_bisec_loop, it_iter:221, fl_diff:9.2708e-05
ff_vfi_az_bisec_loop, it_iter:222, fl_diff:8.8072e-05
ff_vfi_az_bisec_loop, it_iter:223, fl_diff:8.3668e-05
ff_vfi_az_bisec_loop, it_iter:224, fl_diff:7.9485e-05
ff_vfi_az_bisec_loop, it_iter:225, fl_diff:7.551e-05
ff_vfi_az_bisec_loop, it_iter:226, fl_diff:7.1734e-05
ff_vfi_az_bisec_loop, it_iter:227, fl_diff:6.8147e-05
ff_vfi_az_bisec_loop, it_iter:228, fl_diff:6.474e-05
ff_vfi_az_bisec_loop, it_iter:229, fl_diff:6.1502e-05
ff_vfi_az_bisec_loop, it_iter:230, fl_diff:5.8427e-05
ff_vfi_az_bisec_loop, it_iter:231, fl_diff:5.5505e-05
ff_vfi_az_bisec_loop, it_iter:232, fl_diff:5.273e-05
ff_vfi_az_bisec_loop, it_iter:233, fl_diff:5.0093e-05
ff_vfi_az_bisec_loop, it_iter:234, fl_diff:4.7589e-05
ff_vfi_az_bisec_loop, it_iter:235, fl_diff:4.5209e-05
ff_vfi_az_bisec_loop, it_iter:236, fl_diff:4.2948e-05
ff_vfi_az_bisec_loop, it_iter:237, fl_diff:4.0801e-05
ff_vfi_az_bisec_loop, it_iter:238, fl_diff:3.8761e-05
ff_vfi_az_bisec_loop, it_iter:239, fl_diff:3.6823e-05
ff_vfi_az_bisec_loop, it_iter:240, fl_diff:3.4981e-05
ff_vfi_az_bisec_loop, it_iter:241, fl_diff:3.3232e-05
ff_vfi_az_bisec_loop, it_iter:242, fl_diff:3.1571e-05
ff_vfi_az_bisec_loop, it_iter:243, fl_diff:2.9992e-05
ff_vfi_az_bisec_loop, it_iter:244, fl_diff:2.8492e-05
ff_vfi_az_bisec_loop, it_iter:245, fl_diff:2.7068e-05
ff_vfi_az_bisec_loop, it_iter:246, fl_diff:2.5714e-05
ff_vfi_az_bisec_loop, it_iter:247, fl_diff:2.4429e-05
ff_vfi_az_bisec_loop, it_iter:248, fl_diff:2.3207e-05
ff_vfi_az_bisec_loop, it_iter:249, fl_diff:2.2047e-05
ff_vfi_az_bisec_loop, it_iter:250, fl_diff:2.0944e-05
ff_vfi_az_bisec_loop, it_iter:251, fl_diff:1.9897e-05
ff_vfi_az_bisec_loop, it_iter:252, fl_diff:1.8902e-05
ff_vfi_az_bisec_loop, it_iter:253, fl_diff:1.7957e-05
ff_vfi_az_bisec_loop, it_iter:254, fl_diff:1.7059e-05
ff_vfi_az_bisec_loop, it_iter:255, fl_diff:1.6206e-05
ff_vfi_az_bisec_loop, it_iter:256, fl_diff:1.5396e-05
ff_vfi_az_bisec_loop, it_iter:257, fl_diff:1.4626e-05
ff_vfi_az_bisec_loop, it_iter:258, fl_diff:1.3895e-05
ff_vfi_az_bisec_loop, it_iter:259, fl_diff:1.32e-05
ff_vfi_az_bisec_loop, it_iter:260, fl_diff:1.254e-05
ff_vfi_az_bisec_loop, it_iter:261, fl_diff:1.1913e-05
ff_vfi_az_bisec_loop, it_iter:262, fl_diff:1.1317e-05
ff_vfi_az_bisec_loop, it_iter:263, fl_diff:1.0751e-05
ff_vfi_az_bisec_loop, it_iter:264, fl_diff:1.0214e-05
ff_vfi_az_bisec_loop, it_iter:265, fl_diff:9.7032e-06
ff_vfi_az_bisec_loop, it_iter:266, fl_diff:9.218e-06
</pre><h2 id="12">Convergence Results</h2><pre class="codeinput">it_iter_last = it_iter;
mt_val_cur = mt_val_lst;
mt_aprime = mt_aprime_lst;
<span class="keyword">if</span> fl_diff &lt;= fl_tol_val || it_iter&gt;=it_maxiter_val
    <span class="keyword">if</span> (it_iter&gt;=it_maxiter_val)
        flag = 2;
    <span class="keyword">else</span>
        flag = 1;
    <span class="keyword">end</span>
<span class="keyword">else</span>
    flag = 0;
<span class="keyword">end</span>

<span class="keyword">if</span> (bl_timer)
    toc
<span class="keyword">end</span>
</pre><pre class="codeoutput">Elapsed time is 0.235964 seconds.
</pre><h2 id="13">Results for Printing, and Graphing</h2><pre class="codeinput">mp_print_graph = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
mp_print_graph(<span class="string">'v'</span>) = mt_val_cur;
mp_print_graph(<span class="string">'ap'</span>) = mt_aprime;
<span class="keyword">if</span> (bl_store_more)
    mp_print_graph(<span class="string">'c'</span>) = mt_c;
    mp_print_graph(<span class="string">'y'</span>) = mt_y;
    mp_print_graph(<span class="string">'coh'</span>) = mt_coh;
    mp_print_graph(<span class="string">'savefraccoh'</span>) = mt_aprime./mt_coh;
<span class="keyword">end</span>
</pre><h2 id="14">Print Parameter Information</h2><pre class="codeinput"><span class="keyword">if</span> (bl_print_params)
    ff_container_map_display(mp_params);
    ff_container_map_display(mp_support);
<span class="keyword">end</span>
</pre><pre class="codeoutput">----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CONTAINER NAME: mp_params Scalars
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                    i     idx    value
                    __    ___    _____

    fl_a_max         1     1       50 
    fl_a_min         2     2        0 
    fl_beta          3     3     0.95 
    fl_crra          4     4      1.5 
    fl_r             5     5     0.04 
    fl_shk_std       6     6      0.2 
    fl_w             7     7      1.4 
    fl_z_persist     8     8      0.8 
    it_a_n           9     9      100 
    it_z_n          10    10        7 

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CONTAINER NAME: mp_params String
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                     i     idx          string      
                    ___    ____    _________________

    st_grid_type    "1"    "11"    "grid_powerspace"

pos = 11 ; key = ls_ffsna
    'ap'

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CONTAINER NAME: mp_support Scalars
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                               i    idx    value 
                               _    ___    ______

    bl_print_iterinfo          1     1          1
    bl_print_params            2     2          1
    bl_timer                   3     3          1
    ffsna_opt_it_col_n_keep    4     4          9
    ffsna_opt_it_row_n_keep    5     5         10
    fl_lowestc                 6     6     -1e+10
    fl_tol_val                 7     7      1e-05
    it_maxiter_val             8     8        500

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CONTAINER NAME: mp_support String
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                 i     idx               string          
                ___    ____    __________________________

    ls_ffcmd    "1"    "9"     "v;ap;c;y;coh;savefraccoh"
    ls_ffgrh    "2"    "10"    "v;ap;c;y;savefraccoh"    
    ls_slout    "3"    "12"    "v;ap;c;y;coh;savefraccoh"
    ls_store    "4"    "13"    "v;ap;c;y;coh"            

</pre><h2 id="15">Show Value Function Convergence Information</h2><pre class="codeinput"><span class="keyword">if</span> (bl_print_iterinfo)

    it_z_select = unique(round(linspace(1,length(ar_z), 7)));
    ar_z_select = ar_z(it_z_select);
    tb_valpol_alliter = array2table([ar_val_diff_norm(1:it_iter_last)';<span class="keyword">...</span>
                                     ar_pol_diff_norm(1:it_iter_last)';<span class="keyword">...</span>
                                     mt_pol_perc_change(1:it_iter_last,it_z_select)']');
    ar_st_col_zs = matlab.lang.makeValidName(strcat(<span class="string">'z='</span>, string(ar_z_select)));
    cl_col_names = [<span class="string">'valgap'</span>, <span class="string">'polgap'</span>, ar_st_col_zs];
    cl_row_names = strcat(<span class="string">'iter='</span>, string(1:it_iter_last));
    tb_valpol_alliter.Properties.VariableNames = cl_col_names;
    tb_valpol_alliter.Properties.RowNames = cl_row_names;
    disp(<span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>);
    disp(<span class="string">'Value Function Iteration Per Iteration Changes'</span>);
    disp(<span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>);
    disp(<span class="string">'valgap = norm(mt_val - mt_val_cur): value function difference across iterations'</span>);
    disp(<span class="string">'polgap = norm(mt_pol_a - mt_pol_a_cur): policy function difference across iterations'</span>);
    disp([<span class="string">'z1 = z1 perc change: sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n): percentage of state space'</span><span class="keyword">...</span>
          <span class="string">' points conditional on shock where the policy function is changing across iterations'</span>]);
        disp(tb_valpol_alliter);

<span class="keyword">end</span>
</pre><pre class="codeoutput">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Value Function Iteration Per Iteration Changes
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
valgap = norm(mt_val - mt_val_cur): value function difference across iterations
polgap = norm(mt_pol_a - mt_pol_a_cur): policy function difference across iterations
z1 = z1 perc change: sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n): percentage of state space points conditional on shock where the policy function is changing across iterations
                  valgap      polgap     z_0_41816    z_0_54897    z_0_72069    z_0_94612    z_1_2421    z_1_6306    z_2_1407
                __________    _______    _________    _________    _________    _________    ________    ________    ________

    iter=1          34.289          0         0            0            0            0            0           0           0  
    iter=2          25.322      277.4      0.92         0.92         0.94            1            1           1           1  
    iter=3          20.929     92.733      0.85         0.84         0.87            1            1           1           1  
    iter=4          17.936     46.304      0.73         0.85         0.84         0.89            1           1           1  
    iter=5          15.688     27.525      0.74         0.72         0.78         0.84         0.85        0.99           1  
    iter=6           13.91     18.948       0.6         0.57         0.66         0.68         0.78        0.83        0.92  
    iter=7          12.456     13.255      0.44         0.44          0.5         0.54         0.56        0.66        0.69  
    iter=8          11.237     10.001      0.26         0.26         0.33         0.38         0.49        0.54        0.58  
    iter=9            10.2     8.3459      0.22         0.28         0.27         0.29         0.33        0.35        0.45  
    iter=10         9.3022     6.4369      0.11         0.26         0.19         0.26         0.29        0.29        0.36  
    iter=11         8.5194     6.7961      0.12         0.21         0.16         0.19         0.19        0.26        0.28  
    iter=12         7.8306     4.0701      0.23         0.09         0.08         0.12          0.2        0.27        0.22  
    iter=13         7.2177     4.2137      0.13          0.1         0.09         0.16         0.17        0.15        0.23  
    iter=14         6.6717     4.2145      0.11          0.1         0.08         0.13         0.09        0.12         0.2  
    iter=15          6.184     4.3187       0.1         0.09         0.07         0.08         0.12        0.14        0.15  
    iter=16         5.7438      3.992      0.09         0.03            0         0.05         0.09        0.13        0.12  
    iter=17          5.341     2.6714         0            0            0         0.08         0.11        0.11        0.09  
    iter=18         4.9701     2.4872         0         0.01            0         0.06         0.08        0.06        0.08  
    iter=19         4.6287     2.6982         0            0         0.12         0.07         0.09        0.06        0.08  
    iter=20         4.3163     2.4189      0.01            0         0.15         0.07         0.04        0.05        0.04  
    iter=21         4.0301     2.7372         0            0         0.09         0.06         0.02        0.09        0.12  
    iter=22         3.7679     3.4505         0            0         0.09         0.06         0.03        0.04        0.07  
    iter=23         3.5273     2.6704         0            0         0.08         0.01         0.03        0.05        0.02  
    iter=24         3.3055     3.0985         0            0         0.08            0         0.03        0.04        0.04  
    iter=25         3.1008     2.4261         0         0.01         0.05         0.01         0.01        0.02        0.05  
    iter=26         2.9109     2.7049         0          0.1            0            0         0.03        0.07        0.02  
    iter=27         2.7362     4.4409         0         0.21            0         0.01         0.02        0.05        0.02  
    iter=28         2.5744     2.2918         0         0.05         0.01         0.01         0.03        0.02        0.02  
    iter=29         2.4231     2.1533         0         0.02            0            0         0.02        0.04        0.04  
    iter=30         2.2815     4.3567      0.15         0.01            0            0         0.02        0.03        0.01  
    iter=31         2.1498     2.4368      0.07         0.01            0            0         0.02        0.01        0.03  
    iter=32         2.0256     1.5316      0.03         0.01            0            0         0.02           0        0.03  
    iter=33         1.9085     1.2249      0.02         0.01            0            0         0.02        0.01        0.02  
    iter=34         1.7983     1.2729      0.01            0         0.01            0         0.02           0        0.02  
    iter=35         1.6946     1.3216      0.01         0.01            0            0         0.02        0.01           0  
    iter=36         1.5971      1.017      0.01            0            0            0         0.01           0        0.03  
    iter=37         1.5054     1.6114      0.01         0.02            0            0         0.02        0.02        0.01  
    iter=38         1.4193     1.6916         0            0            0            0         0.02           0        0.02  
    iter=39         1.3385     1.0491      0.01            0            0            0         0.01           0        0.01  
    iter=40         1.2625     1.5221         0            0            0            0         0.02        0.01        0.02  
    iter=41         1.1912     1.5737      0.01         0.01            0         0.01         0.02        0.01        0.01  
    iter=42         1.1241     1.1403         0            0            0            0         0.01           0        0.01  
    iter=43         1.0611     1.6521         0            0            0            0         0.02           0        0.02  
    iter=44          1.002     1.7052         0            0            0            0         0.02        0.01        0.02  
    iter=45        0.94638      1.234      0.01            0            0            0         0.01           0        0.01  
    iter=46        0.89412     1.2531         0            0            0            0         0.01        0.01        0.01  
    iter=47        0.84489     1.1219         0            0            0            0            0           0        0.01  
    iter=48         0.7985      0.664         0            0            0            0         0.01        0.01           0  
    iter=49        0.75475    0.19503         0            0            0            0            0        0.01           0  
    iter=50        0.71346     1.1403         0         0.01            0            0            0           0        0.01  
    iter=51         0.6745    0.64861      0.01            0            0            0            0           0           0  
    iter=52         0.6377    0.11898         0            0            0            0            0        0.01           0  
    iter=53        0.60297     1.1589         0            0            0            0            0           0        0.01  
    iter=54        0.57016          0         0            0            0            0            0           0           0  
    iter=55        0.53917     0.6795         0            0            0            0            0        0.01        0.01  
    iter=56        0.50992      1.211         0            0            0            0            0           0        0.02  
    iter=57         0.4823          0         0            0            0            0            0           0           0  
    iter=58         0.4562          0         0            0            0            0            0           0           0  
    iter=59        0.43154          0         0            0            0            0            0           0           0  
    iter=60        0.40825     1.1963         0            0            0            0            0           0        0.01  
    iter=61        0.38625          0         0            0            0            0            0           0           0  
    iter=62        0.36545          0         0            0            0            0            0           0           0  
    iter=63        0.34581          0         0            0            0            0            0           0           0  
    iter=64        0.32724          0         0            0            0            0            0           0           0  
    iter=65         0.3097     1.2151         0            0            0            0            0           0        0.01  
    iter=66        0.29313          0         0            0            0            0            0           0           0  
    iter=67        0.27746    0.36776         0            0            0            0            0        0.01           0  
    iter=68        0.26265          0         0            0            0            0            0           0           0  
    iter=69        0.24866    0.44641         0            0            0            0            0           0        0.01  
    iter=70        0.23542          0         0            0            0            0            0           0           0  
    iter=71        0.22292      1.234         0            0            0            0            0           0        0.01  
    iter=72         0.2111    0.69512      0.01            0            0            0            0        0.01           0  
    iter=73        0.19992          0         0            0            0            0            0           0           0  
    iter=74        0.18935          0         0            0            0            0            0           0           0  
    iter=75        0.17935          0         0            0            0            0            0           0           0  
    iter=76        0.16989          0         0            0            0            0            0           0           0  
    iter=77        0.16094      0.102         0            0            0            0            0        0.01           0  
    iter=78        0.15248          0         0            0            0            0            0           0           0  
    iter=79        0.14447          0         0            0            0            0            0           0           0  
    iter=80         0.1369          0         0            0            0            0            0           0           0  
    iter=81        0.12974     1.2531         0            0            0            0            0           0        0.01  
    iter=82        0.12295          0         0            0            0            0            0           0           0  
    iter=83        0.11654          0         0            0            0            0            0           0           0  
    iter=84        0.11046          0         0            0            0            0            0           0           0  
    iter=85        0.10471          0         0            0            0            0            0           0           0  
    iter=86       0.099265          0         0            0            0            0            0           0           0  
    iter=87        0.09411          0         0            0            0            0            0           0           0  
    iter=88       0.089228          0         0            0            0            0            0           0           0  
    iter=89       0.084606          0         0            0            0            0            0           0           0  
    iter=90       0.080229          0         0            0            0            0            0           0           0  
    iter=91       0.076083          0         0            0            0            0            0           0           0  
    iter=92       0.072155          0         0            0            0            0            0           0           0  
    iter=93       0.068435          0         0            0            0            0            0           0           0  
    iter=94        0.06491          0         0            0            0            0            0           0           0  
    iter=95       0.061571          0         0            0            0            0            0           0           0  
    iter=96       0.058406          0         0            0            0            0            0           0           0  
    iter=97       0.055408          0         0            0            0            0            0           0           0  
    iter=98       0.052566          0         0            0            0            0            0           0           0  
    iter=99       0.049872          0         0            0            0            0            0           0           0  
    iter=100      0.047319          0         0            0            0            0            0           0           0  
    iter=101      0.044899          0         0            0            0            0            0           0           0  
    iter=102      0.042604          0         0            0            0            0            0           0           0  
    iter=103      0.040429          0         0            0            0            0            0           0           0  
    iter=104      0.038366          0         0            0            0            0            0           0           0  
    iter=105       0.03641          0         0            0            0            0            0           0           0  
    iter=106      0.034556          0         0            0            0            0            0           0           0  
    iter=107      0.032797          0         0            0            0            0            0           0           0  
    iter=108      0.031129          0         0            0            0            0            0           0           0  
    iter=109      0.029546          0         0            0            0            0            0           0           0  
    iter=110      0.028046          0         0            0            0            0            0           0           0  
    iter=111      0.026622          0         0            0            0            0            0           0           0  
    iter=112      0.025271          0         0            0            0            0            0           0           0  
    iter=113       0.02399          0         0            0            0            0            0           0           0  
    iter=114      0.022774          0         0            0            0            0            0           0           0  
    iter=115      0.021621          0         0            0            0            0            0           0           0  
    iter=116      0.020527          0         0            0            0            0            0           0           0  
    iter=117      0.019488          0         0            0            0            0            0           0           0  
    iter=118      0.018503          0         0            0            0            0            0           0           0  
    iter=119      0.017567          0         0            0            0            0            0           0           0  
    iter=120       0.01668          0         0            0            0            0            0           0           0  
    iter=121      0.015838          0         0            0            0            0            0           0           0  
    iter=122      0.015038          0         0            0            0            0            0           0           0  
    iter=123      0.014279          0         0            0            0            0            0           0           0  
    iter=124      0.013559          0         0            0            0            0            0           0           0  
    iter=125      0.012876          0         0            0            0            0            0           0           0  
    iter=126      0.012227          0         0            0            0            0            0           0           0  
    iter=127      0.011611          0         0            0            0            0            0           0           0  
    iter=128      0.011026          0         0            0            0            0            0           0           0  
    iter=129      0.010471          0         0            0            0            0            0           0           0  
    iter=130     0.0099436          0         0            0            0            0            0           0           0  
    iter=131     0.0094432          0         0            0            0            0            0           0           0  
    iter=132     0.0089681          0         0            0            0            0            0           0           0  
    iter=133     0.0085171          0         0            0            0            0            0           0           0  
    iter=134     0.0080888          0         0            0            0            0            0           0           0  
    iter=135     0.0076822          0         0            0            0            0            0           0           0  
    iter=136     0.0072961          0         0            0            0            0            0           0           0  
    iter=137     0.0069295          0         0            0            0            0            0           0           0  
    iter=138     0.0065814          0         0            0            0            0            0           0           0  
    iter=139     0.0062508          0         0            0            0            0            0           0           0  
    iter=140      0.005937          0         0            0            0            0            0           0           0  
    iter=141     0.0056389          0         0            0            0            0            0           0           0  
    iter=142     0.0053558          0         0            0            0            0            0           0           0  
    iter=143      0.005087          0         0            0            0            0            0           0           0  
    iter=144     0.0048318          0         0            0            0            0            0           0           0  
    iter=145     0.0045894          0         0            0            0            0            0           0           0  
    iter=146     0.0043591          0         0            0            0            0            0           0           0  
    iter=147     0.0041405          0         0            0            0            0            0           0           0  
    iter=148     0.0039328          0         0            0            0            0            0           0           0  
    iter=149     0.0037356          0         0            0            0            0            0           0           0  
    iter=150     0.0035483          0         0            0            0            0            0           0           0  
    iter=151     0.0033705          0         0            0            0            0            0           0           0  
    iter=152     0.0032015          0         0            0            0            0            0           0           0  
    iter=153     0.0030411          0         0            0            0            0            0           0           0  
    iter=154     0.0028887          0         0            0            0            0            0           0           0  
    iter=155     0.0027439          0         0            0            0            0            0           0           0  
    iter=156     0.0026064          0         0            0            0            0            0           0           0  
    iter=157     0.0024758          0         0            0            0            0            0           0           0  
    iter=158     0.0023518          0         0            0            0            0            0           0           0  
    iter=159      0.002234          0         0            0            0            0            0           0           0  
    iter=160     0.0021221          0         0            0            0            0            0           0           0  
    iter=161     0.0020158          0         0            0            0            0            0           0           0  
    iter=162     0.0019149          0         0            0            0            0            0           0           0  
    iter=163      0.001819          0         0            0            0            0            0           0           0  
    iter=164     0.0017279          0         0            0            0            0            0           0           0  
    iter=165     0.0016414          0         0            0            0            0            0           0           0  
    iter=166     0.0015592          0         0            0            0            0            0           0           0  
    iter=167     0.0014812          0         0            0            0            0            0           0           0  
    iter=168      0.001407          0         0            0            0            0            0           0           0  
    iter=169     0.0013366          0         0            0            0            0            0           0           0  
    iter=170     0.0012697          0         0            0            0            0            0           0           0  
    iter=171     0.0012061          0         0            0            0            0            0           0           0  
    iter=172     0.0011458          0         0            0            0            0            0           0           0  
    iter=173     0.0010884          0         0            0            0            0            0           0           0  
    iter=174      0.001034          0         0            0            0            0            0           0           0  
    iter=175    0.00098221          0         0            0            0            0            0           0           0  
    iter=176    0.00093306          0         0            0            0            0            0           0           0  
    iter=177    0.00088637          0         0            0            0            0            0           0           0  
    iter=178    0.00084201          0         0            0            0            0            0           0           0  
    iter=179    0.00079988          0         0            0            0            0            0           0           0  
    iter=180    0.00075986          0         0            0            0            0            0           0           0  
    iter=181    0.00072184          0         0            0            0            0            0           0           0  
    iter=182    0.00068573          0         0            0            0            0            0           0           0  
    iter=183    0.00065142          0         0            0            0            0            0           0           0  
    iter=184    0.00061883          0         0            0            0            0            0           0           0  
    iter=185    0.00058787          0         0            0            0            0            0           0           0  
    iter=186    0.00055846          0         0            0            0            0            0           0           0  
    iter=187    0.00053053          0         0            0            0            0            0           0           0  
    iter=188    0.00050399          0         0            0            0            0            0           0           0  
    iter=189    0.00047878          0         0            0            0            0            0           0           0  
    iter=190    0.00045483          0         0            0            0            0            0           0           0  
    iter=191    0.00043208          0         0            0            0            0            0           0           0  
    iter=192    0.00041046          0         0            0            0            0            0           0           0  
    iter=193    0.00038993          0         0            0            0            0            0           0           0  
    iter=194    0.00037043          0         0            0            0            0            0           0           0  
    iter=195     0.0003519          0         0            0            0            0            0           0           0  
    iter=196     0.0003343          0         0            0            0            0            0           0           0  
    iter=197    0.00031758          0         0            0            0            0            0           0           0  
    iter=198     0.0003017          0         0            0            0            0            0           0           0  
    iter=199    0.00028661          0         0            0            0            0            0           0           0  
    iter=200    0.00027227          0         0            0            0            0            0           0           0  
    iter=201    0.00025866          0         0            0            0            0            0           0           0  
    iter=202    0.00024572          0         0            0            0            0            0           0           0  
    iter=203    0.00023343          0         0            0            0            0            0           0           0  
    iter=204    0.00022176          0         0            0            0            0            0           0           0  
    iter=205    0.00021067          0         0            0            0            0            0           0           0  
    iter=206    0.00020013          0         0            0            0            0            0           0           0  
    iter=207    0.00019012          0         0            0            0            0            0           0           0  
    iter=208    0.00018061          0         0            0            0            0            0           0           0  
    iter=209    0.00017158          0         0            0            0            0            0           0           0  
    iter=210      0.000163          0         0            0            0            0            0           0           0  
    iter=211    0.00015485          0         0            0            0            0            0           0           0  
    iter=212    0.00014711          0         0            0            0            0            0           0           0  
    iter=213    0.00013975          0         0            0            0            0            0           0           0  
    iter=214    0.00013276          0         0            0            0            0            0           0           0  
    iter=215    0.00012612          0         0            0            0            0            0           0           0  
    iter=216    0.00011982          0         0            0            0            0            0           0           0  
    iter=217    0.00011382          0         0            0            0            0            0           0           0  
    iter=218    0.00010813          0         0            0            0            0            0           0           0  
    iter=219    0.00010272          0         0            0            0            0            0           0           0  
    iter=220    9.7588e-05          0         0            0            0            0            0           0           0  
    iter=221    9.2708e-05          0         0            0            0            0            0           0           0  
    iter=222    8.8072e-05          0         0            0            0            0            0           0           0  
    iter=223    8.3668e-05          0         0            0            0            0            0           0           0  
    iter=224    7.9485e-05          0         0            0            0            0            0           0           0  
    iter=225     7.551e-05          0         0            0            0            0            0           0           0  
    iter=226    7.1734e-05          0         0            0            0            0            0           0           0  
    iter=227    6.8147e-05          0         0            0            0            0            0           0           0  
    iter=228     6.474e-05          0         0            0            0            0            0           0           0  
    iter=229    6.1502e-05          0         0            0            0            0            0           0           0  
    iter=230    5.8427e-05          0         0            0            0            0            0           0           0  
    iter=231    5.5505e-05          0         0            0            0            0            0           0           0  
    iter=232     5.273e-05          0         0            0            0            0            0           0           0  
    iter=233    5.0093e-05          0         0            0            0            0            0           0           0  
    iter=234    4.7589e-05          0         0            0            0            0            0           0           0  
    iter=235    4.5209e-05          0         0            0            0            0            0           0           0  
    iter=236    4.2948e-05          0         0            0            0            0            0           0           0  
    iter=237    4.0801e-05          0         0            0            0            0            0           0           0  
    iter=238    3.8761e-05          0         0            0            0            0            0           0           0  
    iter=239    3.6823e-05          0         0            0            0            0            0           0           0  
    iter=240    3.4981e-05          0         0            0            0            0            0           0           0  
    iter=241    3.3232e-05          0         0            0            0            0            0           0           0  
    iter=242    3.1571e-05          0         0            0            0            0            0           0           0  
    iter=243    2.9992e-05          0         0            0            0            0            0           0           0  
    iter=244    2.8492e-05          0         0            0            0            0            0           0           0  
    iter=245    2.7068e-05          0         0            0            0            0            0           0           0  
    iter=246    2.5714e-05          0         0            0            0            0            0           0           0  
    iter=247    2.4429e-05          0         0            0            0            0            0           0           0  
    iter=248    2.3207e-05          0         0            0            0            0            0           0           0  
    iter=249    2.2047e-05          0         0            0            0            0            0           0           0  
    iter=250    2.0944e-05          0         0            0            0            0            0           0           0  
    iter=251    1.9897e-05          0         0            0            0            0            0           0           0  
    iter=252    1.8902e-05          0         0            0            0            0            0           0           0  
    iter=253    1.7957e-05          0         0            0            0            0            0           0           0  
    iter=254    1.7059e-05          0         0            0            0            0            0           0           0  
    iter=255    1.6206e-05          0         0            0            0            0            0           0           0  
    iter=256    1.5396e-05          0         0            0            0            0            0           0           0  
    iter=257    1.4626e-05          0         0            0            0            0            0           0           0  
    iter=258    1.3895e-05          0         0            0            0            0            0           0           0  
    iter=259      1.32e-05          0         0            0            0            0            0           0           0  
    iter=260     1.254e-05          0         0            0            0            0            0           0           0  
    iter=261    1.1913e-05          0         0            0            0            0            0           0           0  
    iter=262    1.1317e-05          0         0            0            0            0            0           0           0  
    iter=263    1.0751e-05          0         0            0            0            0            0           0           0  
    iter=264    1.0214e-05          0         0            0            0            0            0           0           0  
    iter=265    9.7032e-06          0         0            0            0            0            0           0           0  
    iter=266     9.218e-06          0         0            0            0            0            0           0           0  

</pre><h2 id="16">ls_ffcmd summary</h2><pre class="codeinput"><span class="keyword">if</span> (~isempty(ls_ffcmd))
    mp_ffcmd = containers.Map(ls_ffcmd, values(mp_print_graph, ls_ffcmd));
    ff_container_map_display(mp_ffcmd, ffsna_opt_it_row_n_keep, ffsna_opt_it_col_n_keep);
<span class="keyword">end</span>
</pre><pre class="codeoutput">----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CONTAINER NAME: mp_ffcmd ND Array (Matrix etc)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                   i    idx    ndim    numel    rowN    colN     sum       mean        std      coefvari      min        max  
                   _    ___    ____    _____    ____    ____    ______    _______    _______    ________    _______    _______

    ap             1     1      2       700     100      7       10003     14.291     14.535     1.0171           0         50
    c              2     2      2       700     100      7      1545.9     2.2084    0.89372    0.40469     0.58543     4.9969
    coh            3     3      2       700     100      7       11549     16.499     15.385    0.93246     0.58543     54.997
    savefraccoh    4     4      2       700     100      7      479.94    0.68563    0.27152    0.39602           0    0.93121
    v              5     5      2       700     100      7      7299.4     10.428     4.5262    0.43406      1.6927     19.139
    y              6     6      2       700     100      7      1473.6     2.1052     0.9999    0.47497     0.58543     4.9969

xxx TABLE:ap xxxxxxxxxxxxxxxxxx
              c1        c2          c3           c4         c5         c6        c7  
            ______    ______    __________    ________    _______    ______    ______

    r1           0         0             0    0.092813    0.31242    0.7048    1.3008
    r2           0         0             0    0.092813    0.31242    0.7048    1.3008
    r3           0         0             0    0.092813    0.31242    0.7048    1.3008
    r4           0         0             0    0.092813    0.31242    0.7048    1.3008
    r5           0         0    0.00051272    0.092813    0.31242    0.7048    1.3008
    r96     43.924    43.924        43.924      43.924     45.102    45.102    46.298
    r97     45.102    45.102        45.102      45.102     46.298    46.298    47.513
    r98     46.298    46.298        46.298      46.298     47.513    47.513    48.747
    r99     47.513    47.513        47.513      47.513     48.747    48.747        50
    r100    48.747    48.747        48.747      48.747         50        50        50

xxx TABLE:c xxxxxxxxxxxxxxxxxx
              c1         c2         c3        c4        c5        c6        c7  
            _______    _______    ______    ______    ______    ______    ______

    r1      0.58543    0.76855     1.009    1.2318    1.4265     1.578    1.6961
    r2      0.58596    0.76909    1.0095    1.2323     1.427    1.5786    1.6967
    r3      0.58845    0.77157     1.012    1.2348    1.4295    1.5811    1.6992
    r4      0.59374    0.77687    1.0173    1.2401    1.4348    1.5864    1.7045
    r5      0.60249    0.78562    1.0255    1.2488    1.4435    1.5951    1.7132
    r96       3.567     3.7501    3.9905    4.3062     3.543    4.0869    3.6047
    r97      3.6336     3.8167    4.0571    4.3727    3.5908    4.1347    3.6337
    r98      3.7011     3.8842    4.1246    4.4402    3.6394    4.1834    3.6634
    r99      3.7693     3.9525    4.1929    4.5085    3.6888    4.2327    3.6937
    r100     3.8385     4.0216     4.262    4.5776    3.7389    4.2828    4.9969

xxx TABLE:coh xxxxxxxxxxxxxxxxxx
              c1         c2         c3        c4        c5        c6        c7  
            _______    _______    ______    ______    ______    ______    ______

    r1      0.58543    0.76855     1.009    1.3246    1.7389    2.2828    2.9969
    r2      0.58596    0.76909    1.0095    1.3251    1.7394    2.2834    2.9974
    r3      0.58845    0.77157     1.012    1.3276    1.7419    2.2859    2.9999
    r4      0.59374    0.77687    1.0173    1.3329    1.7472    2.2911    3.0052
    r5      0.60249    0.78562     1.026    1.3416     1.756    2.2999     3.014
    r96      47.491     47.674    47.915     48.23    48.644    49.188    49.902
    r97      48.735     48.918    49.159    49.474    49.889    50.433    51.147
    r98      49.999     50.182    50.422    50.738    51.152    51.696     52.41
    r99      51.282     51.465    51.706    52.021    52.436     52.98    53.694
    r100     52.585     52.769    53.009    53.325    53.739    54.283    54.997

xxx TABLE:savefraccoh xxxxxxxxxxxxxxxxxx
              c1         c2           c3           c4         c5         c6         c7   
            _______    _______    __________    ________    _______    _______    _______

    r1            0          0             0     0.07007    0.17967    0.30874    0.43404
    r2            0          0             0    0.070042    0.17961    0.30866    0.43396
    r3            0          0             0    0.069911    0.17935    0.30833     0.4336
    r4            0          0             0    0.069633    0.17881    0.30762    0.43284
    r5            0          0    0.00049972    0.069179    0.17792    0.30645    0.43158
    r96     0.92489    0.92134       0.91672     0.91072    0.92717    0.91691    0.92776
    r97     0.92544    0.92198       0.91747     0.91162    0.92802    0.91801    0.92895
    r98     0.92598     0.9226        0.9182     0.91249    0.92885    0.91908     0.9301
    r99      0.9265     0.9232       0.91891     0.91333    0.92965    0.92011    0.93121
    r100      0.927    0.92379        0.9196     0.91416    0.93042     0.9211    0.90914

xxx TABLE:v xxxxxxxxxxxxxxxxxx
              c1        c2        c3        c4        c5        c6        c7  
            ______    ______    ______    ______    ______    ______    ______

    r1      1.6927    2.9404    4.0961    5.1825    6.2429    7.3118    8.4139
    r2      1.6939    2.9412    4.0966    5.1829    6.2432    7.3121    8.4142
    r3      1.6994    2.9449    4.0991    5.1847    6.2446    7.3134    8.4153
    r4       1.711    2.9527    4.1042    5.1885    6.2477     7.316    8.4177
    r5      1.7299    2.9653    4.1127    5.1948    6.2528    7.3204    8.4216
    r96     17.243    17.396    17.566    17.758    17.992     18.26    18.553
    r97     17.421     17.57    17.736    17.924    18.152    18.415      18.7
    r98     17.598    17.743    17.905    18.088    18.311    18.569    18.847
    r99     17.773    17.914    18.072    18.252     18.47    18.722    18.993
    r100    17.947    18.084    18.239    18.414    18.627    18.874    19.139

xxx TABLE:y xxxxxxxxxxxxxxxxxx
              c1         c2         c3        c4        c5        c6        c7  
            _______    _______    ______    ______    ______    ______    ______

    r1      0.58543    0.76855     1.009    1.3246    1.7389    2.2828    2.9969
    r2      0.58545    0.76858     1.009    1.3246    1.7389    2.2829    2.9969
    r3      0.58555    0.76867    1.0091    1.3247     1.739     2.283     2.997
    r4      0.58575    0.76887    1.0093    1.3249    1.7392    2.2832    2.9972
    r5      0.58609    0.76921    1.0096    1.3252    1.7396    2.2835    2.9976
    r96      2.3895     2.5726     2.813    3.1286     3.543    4.0869     4.801
    r97      2.4373     2.6205    2.8609    3.1765    3.5908    4.1347    4.8488
    r98      2.4859     2.6691    2.9095    3.2251    3.6394    4.1834    4.8974
    r99      2.5353     2.7184    2.9588    3.2744    3.6888    4.2327    4.9468
    r100     2.5854     2.7686     3.009    3.3246    3.7389    4.2828    4.9969

</pre><h2 id="17">ls_ffsna summarize full</h2><pre class="codeinput"><span class="keyword">if</span> (~isempty(ls_ffsna))

    <span class="comment">% container map subseting</span>
    mp_ffsna = containers.Map(ls_ffsna, values(mp_print_graph, ls_ffsna));

    <span class="comment">% ff_summ_nd_array parameters</span>
    it_aggd = 0;
    bl_row = 1;
    ar_permute = [2,1];
    ar_st_stats = [<span class="string">"mean"</span>];
    bl_print_table = true;
    cl_mp_datasetdesc = {};
    cl_mp_datasetdesc{1} = containers.Map({<span class="string">'name'</span>, <span class="string">'labval'</span>}, {<span class="string">'a'</span>, ar_a});
    cl_mp_datasetdesc{2} = containers.Map({<span class="string">'name'</span>, <span class="string">'labval'</span>}, {<span class="string">'z'</span>, ar_z});

    <span class="comment">% summarize</span>
    param_map_keys = keys(mp_ffsna);
    param_map_vals = values(mp_ffsna);
    <span class="keyword">for</span> i = 1:length(mp_ffsna)
        st_mt_name = param_map_keys{i};
        mt_cur = param_map_vals{i};
        st_title = [<span class="string">'ff_vfi_az_vec, outcome='</span> st_mt_name];
        ff_summ_nd_array(st_title, mt_cur, <span class="keyword">...</span>
            bl_print_table, ar_st_stats, it_aggd, bl_row, <span class="keyword">...</span>
            cl_mp_datasetdesc, ar_permute);
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><pre class="codeoutput">xxx  ff_vfi_az_vec, outcome=ap  xxxxxxxxxxxxxxxxxxxxxxxxxxx
    group        a         mean_z_0_41816    mean_z_0_54897    mean_z_0_72069    mean_z_0_94612    mean_z_1_2421    mean_z_1_6306    mean_z_2_1407
    _____    __________    ______________    ______________    ______________    ______________    _____________    _____________    _____________

       1              0              0                 0                  0         0.092813          0.31242           0.7048          1.3008    
       2     0.00051272              0                 0                  0         0.092813          0.31242           0.7048          1.3008    
       3      0.0029004              0                 0                  0         0.092813          0.31242           0.7048          1.3008    
       4      0.0079925              0                 0                  0         0.092813          0.31242           0.7048          1.3008    
       5       0.016407              0                 0         0.00051272         0.092813          0.31242           0.7048          1.3008    
       6       0.028662              0                 0          0.0079925         0.092813          0.31242           0.7048          1.3008    
       7       0.045213              0                 0           0.016407          0.12459          0.37601           0.7048          1.3008    
       8        0.06647              0                 0           0.028662          0.12459          0.37601           0.8068          1.3008    
       9       0.092813      0.0029004          0.016407           0.045213          0.16214          0.37601           0.8068          1.3008    
      10        0.12459       0.016407          0.028662            0.06647          0.20576           0.4468           0.8068          1.3008    
      11        0.16214       0.045213          0.045213           0.092813          0.20576           0.4468           0.8068          1.3008    
      12        0.20576        0.06647           0.06647            0.12459          0.25576          0.52503          0.91719          1.4468    
      13        0.25576       0.092813           0.12459            0.16214          0.31242          0.52503          0.91719          1.4468    
      14        0.31242        0.12459           0.16214            0.20576          0.37601          0.61095           1.0362          1.6023    
      15        0.37601        0.16214           0.20576            0.25576           0.4468          0.61095           1.0362          1.6023    
      16         0.4468        0.20576           0.25576            0.31242           0.4468           0.7048            1.164          1.6023    
      17        0.52503        0.25576           0.31242            0.37601          0.52503           0.8068            1.164          1.7673    
      18        0.61095        0.31242           0.37601             0.4468          0.61095          0.91719           1.3008          1.7673    
      19         0.7048        0.37601            0.4468            0.52503           0.7048          0.91719           1.3008          1.9422    
      20         0.8068        0.52503           0.52503            0.61095           0.8068           1.0362           1.4468          1.9422    
      21        0.91719        0.61095           0.61095             0.7048          0.91719            1.164           1.6023           2.127    
      22         1.0362         0.7048            0.7048             0.8068           1.0362           1.3008           1.7673          2.3221    
      23          1.164         0.8068            0.8068            0.91719            1.164           1.4468           1.7673          2.3221    
      24         1.3008        0.91719           0.91719             1.0362           1.3008           1.6023           1.9422          2.5275    
      25         1.4468         1.0362            1.0362              1.164           1.4468           1.6023            2.127          2.5275    
      26         1.6023          1.164            1.3008             1.3008           1.6023           1.7673           2.3221          2.7434    
      27         1.7673         1.3008            1.4468             1.4468           1.7673           1.9422           2.3221            2.97    
      28         1.9422         1.4468            1.6023             1.6023           1.9422            2.127           2.5275          3.2075    
      29          2.127         1.6023            1.7673             1.7673           1.9422           2.3221           2.7434          3.2075    
      30         2.3221         1.7673            1.9422             1.9422            2.127           2.5275             2.97           3.456    
      31         2.5275         1.9422             2.127              2.127           2.3221           2.7434           3.2075          3.7158    
      32         2.7434          2.127            2.3221             2.3221           2.5275             2.97            3.456          3.9869    
      33           2.97         2.3221            2.5275             2.5275           2.7434           3.2075            3.456          4.2696    
      34         3.2075         2.5275            2.7434             2.7434             2.97            3.456           3.7158          4.2696    
      35          3.456         2.7434              2.97             3.2075           3.2075           3.7158           3.9869           4.564    
      36         3.7158         3.2075            3.2075              3.456            3.456           3.9869           4.2696          4.8702    
      37         3.9869          3.456             3.456             3.7158           3.7158           4.2696            4.564          5.1884    
      38         4.2696         3.7158            3.7158             3.9869           3.9869           4.2696           4.8702          5.5188    
      39          4.564         3.9869            3.9869             4.2696           4.2696            4.564           5.1884          5.8615    
      40         4.8702         4.2696            4.2696              4.564            4.564           4.8702           5.5188          5.8615    
      41         5.1884          4.564             4.564             4.8702           4.8702           5.1884           5.8615          6.2166    
      42         5.5188         4.8702            4.8702             5.1884           5.1884           5.5188           6.2166          6.5844    
      43         5.8615         5.1884            5.1884             5.5188           5.5188           5.8615           6.5844          6.9649    
      44         6.2166         5.5188            5.5188             5.8615           5.8615           6.2166           6.5844          7.3583    
      45         6.5844         5.8615            5.8615             6.2166           6.2166           6.5844           6.9649          7.7647    
      46         6.9649         6.2166            6.2166             6.5844           6.5844           6.9649           7.3583          8.1844    
      47         7.3583         6.5844            6.5844             6.9649           6.9649           7.3583           7.7647          8.6173    
      48         7.7647         6.9649            6.9649             7.3583           7.3583           7.7647           8.1844          9.0637    
      49         8.1844         7.3583            7.3583             7.7647           7.7647           8.1844           8.6173          9.0637    
      50         8.6173         7.7647            7.7647             8.1844           8.1844           8.6173           9.0637          9.5237    
      51         9.0637         8.1844            8.1844             8.6173           8.6173           9.0637           9.5237          9.9975    
      52         9.5237         8.6173            8.6173             9.0637           9.0637           9.5237           9.9975          10.485    
      53         9.9975         9.0637            9.0637             9.5237           9.5237           9.9975           10.485          10.987    
      54         10.485         9.5237            9.5237             9.9975           9.9975           10.485           10.987          11.502    
      55         10.987         9.9975            10.485             10.485           10.485           10.987           11.502          12.032    
      56         11.502         10.485            10.987             10.987           10.987           11.502           12.032          12.577    
      57         12.032         10.987            11.502             11.502           11.502           12.032           12.577          13.136    
      58         12.577         11.502            12.032             12.032           12.032           12.577           13.136          13.709    
      59         13.136         12.032            12.577             12.577           12.577           13.136           13.709          14.298    
      60         13.709         12.577            13.136             13.136           13.136           13.709           14.298          14.901    
      61         14.298         13.136            13.709             13.709           13.709           14.298           14.901          15.519    
      62         14.901         13.709            14.298             14.298           14.298           14.901           15.519          16.152    
      63         15.519         14.298            14.901             14.901           14.901           15.519           16.152          16.801    
      64         16.152         14.901            15.519             15.519           15.519           16.152           16.801          16.801    
      65         16.801         16.152            16.152             16.152           16.152           16.801           17.465          17.465    
      66         17.465         16.801            16.801             16.801           16.801           17.465           18.144          18.144    
      67         18.144         17.465            17.465             17.465           17.465           18.144           18.839          18.839    
      68         18.839         18.144            18.144             18.144           18.144           18.839           18.839           19.55    
      69          19.55         18.839            18.839             18.839           18.839            19.55            19.55          20.277    
      70         20.277          19.55             19.55              19.55            19.55           20.277           20.277           21.02    
      71          21.02         20.277            20.277             20.277           20.277            21.02            21.02          21.778    
      72         21.778          21.02             21.02              21.02            21.02           21.778           21.778          22.553    
      73         22.553         21.778            21.778             21.778           21.778           22.553           22.553          23.345    
      74         23.345         22.553            22.553             22.553           22.553           23.345           23.345          24.152    
      75         24.152         23.345            23.345             23.345           23.345           24.152           24.152          24.977    
      76         24.977         24.152            24.152             24.152           24.152           24.977           24.977          25.818    
      77         25.818         24.977            24.977             24.977           24.977           25.818           25.818          26.675    
      78         26.675         25.818            25.818             25.818           25.818           26.675           26.675           27.55    
      79          27.55         26.675            26.675             26.675           26.675            27.55            27.55          28.441    
      80         28.441          27.55             27.55              27.55            27.55           28.441           28.441           29.35    
      81          29.35         28.441            28.441             28.441           28.441            29.35            29.35          30.276    
      82         30.276          29.35             29.35              29.35            29.35           30.276           30.276          31.219    
      83         31.219         30.276            30.276             30.276           30.276           31.219           31.219          32.179    
      84         32.179         31.219            31.219             31.219           31.219           32.179           32.179          33.157    
      85         33.157         32.179            32.179             32.179           32.179           33.157           33.157          34.153    
      86         34.153         33.157            33.157             33.157           33.157           34.153           34.153          35.166    
      87         35.166         34.153            34.153             34.153           34.153           35.166           35.166          36.198    
      88         36.198         35.166            35.166             35.166           35.166           36.198           36.198          37.247    
      89         37.247         36.198            36.198             36.198           36.198           37.247           37.247          38.314    
      90         38.314         37.247            37.247             37.247           37.247           38.314           38.314          39.399    
      91         39.399         38.314            38.314             38.314           38.314           39.399           39.399          40.503    
      92         40.503         39.399            39.399             39.399           39.399           40.503           40.503          41.625    
      93         41.625         40.503            40.503             40.503           40.503           41.625           41.625          42.765    
      94         42.765         41.625            41.625             41.625           41.625           42.765           42.765          43.924    
      95         43.924         42.765            42.765             42.765           42.765           43.924           43.924          45.102    
      96         45.102         43.924            43.924             43.924           43.924           45.102           45.102          46.298    
      97         46.298         45.102            45.102             45.102           45.102           46.298           46.298          47.513    
      98         47.513         46.298            46.298             46.298           46.298           47.513           47.513          48.747    
      99         48.747         47.513            47.513             47.513           47.513           48.747           48.747              50    
     100             50         48.747            48.747             48.747           48.747               50               50              50    

</pre><h2 id="18">ls_ffgrh graph</h2><pre class="codeinput"><span class="keyword">if</span> (~isempty(ls_ffgrh))

    <span class="comment">% container map subseting</span>
    mp_ffgrh = containers.Map(ls_ffgrh, values(mp_print_graph, ls_ffgrh));

    <span class="comment">% container map settings</span>
    mp_support_graph = containers.Map(<span class="string">'KeyType'</span>, <span class="string">'char'</span>, <span class="string">'ValueType'</span>, <span class="string">'any'</span>);
    mp_support_graph(<span class="string">'cl_st_xtitle'</span>) = {<span class="string">'savings states, a'</span>};
    mp_support_graph(<span class="string">'st_legend_loc'</span>) = <span class="string">'best'</span>;
    mp_support_graph(<span class="string">'bl_graph_logy'</span>) = true; <span class="comment">% do not log</span>
    mp_support_graph(<span class="string">'st_rowvar_name'</span>) = <span class="string">'shock='</span>;
    mp_support_graph(<span class="string">'it_legend_select'</span>) = 5; <span class="comment">% how many shock legends to show</span>
    mp_support_graph(<span class="string">'st_rounding'</span>) = <span class="string">'6.2f'</span>; <span class="comment">% format shock legend</span>
    mp_support_graph(<span class="string">'cl_colors'</span>) = <span class="string">'jet'</span>; <span class="comment">% any predefined matlab colormap</span>

    <span class="comment">% Overide graph options here with external parameters</span>
    <span class="keyword">if</span> (length(varargin)&gt;=3)
        mp_support_graph = [mp_support_graph; mp_support_ext];
    <span class="keyword">end</span>

    <span class="comment">% summarize</span>
    param_map_keys = keys(mp_ffgrh);
    param_map_vals = values(mp_ffgrh);
    <span class="keyword">for</span> i = 1:length(mp_ffgrh)
        <span class="comment">% Get matrix and key</span>
        st_mt_name = param_map_keys{i};
        mt_cur = param_map_vals{i};

        <span class="comment">% Update Title and Y label</span>
        mp_support_graph(<span class="string">'cl_st_graph_title'</span>) = {[st_mt_name <span class="string">'(a,z), savings state =x, shock state = color'</span>]};
        mp_support_graph(<span class="string">'cl_st_ytitle'</span>) = {[st_mt_name <span class="string">'(a,z)'</span>]};

        <span class="comment">% Call function</span>
        ff_graph_grid(mt_cur', ar_z, ar_a, mp_support_graph);
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="ff_vfi_az_vec_01.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_02.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_03.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_04.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_05.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_06.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_07.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_08.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_09.png" alt=""> <img vspace="5" hspace="5" src="ff_vfi_az_vec_10.png" alt=""> <h2 id="19">Store Results for Output</h2><pre class="codeinput">mp_valpol_out = containers.Map(ls_slout, values(mp_print_graph, ls_slout));
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% FF_VFI_AZ_VEC (vectorized grid choice) Dynamic Savings Problem
%    Vectorized faster solution for solving the dynamic programming problem
%    with fixed assets grid using value function iteration. Obtains policy
%    and value functions. Shock is AR(1). This function is vectorized, and
%    generally fairly efficient in memory usage. 
%
%    * MP_PARAMS controls model preference, prices, shock and asset grid
%    parameters.
%    * MP_SUPPORT controls convergence criterion, printing and summary
%    controls
%
%    mp_params = containers.Map('KeyType','char', 'ValueType','any');
%    mp_params('fl_crra') = 1.5;
%    mp_params('fl_beta') = 0.95;
%    mp_params('fl_w') = 1.05;
%    mp_params('fl_r') = 0.03;
%    mp_params('fl_a_min') = 0;
%    mp_params('fl_a_max') = 50;
%    mp_params('it_a_n') = 25;
%    mp_params('st_grid_type') = 'grid_powerspace';
%    mp_params('fl_z_persist') = 0.60;
%    mp_params('fl_shk_std') = 0.10;
%    mp_params('it_z_n') = 5;
%    mp_params('st_grid_type') = 'grid_powerspace';
%
%    mp_support = containers.Map('KeyType','char', 'ValueType','any');
%    mp_support('fl_lowestc') = -10e10;
%    mp_support('it_maxiter_val') = 500;
%    mp_support('fl_tol_val') = 10e-5;
%    % printer various information
%    mp_support('bl_timer') = true;
%    mp_support('bl_print_params') = false; 
%    mp_support('bl_print_iterinfo') = false; 
%    % These names must match keys of mp_solu: v=value, ap=savings choice,
%    c=consumption, y=income, coh=cash-on-hand (income + savings),
%    savefraccoh = ap/coh.
%    % what outcomes to store in the mp_solu for export  
%    mp_support('ls_slout') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'}; 
%    % outcome for ff_container_map_display
%    mp_support('ls_ffcmd') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'}; 
%    % outcome for ff_summ_nd_array
%    mp_support('ls_ffsna') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'}; 
%    % outcome for ff_graph_grid
%    mp_support('ls_ffgrh') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'}; 
%    % outcome for ff_summ_nd_array
%    mp_support('ffsna_opt_it_row_n_keep') = 10;
%    % outcome for ff_summ_nd_array
%    mp_support('ffsna_opt_it_col_n_keep') = 9; 
%
%    [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC() default savings and shock
%    model simulation
%
%    [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC(MP_PARAMS) change model
%    parameters through MP_PARAMS
%
%    [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC(MP_PARAMS, MP_SUPPORT) change
%    various printing, storaging, graphing, convergence etc controls
%    through MP_SUPPORT
%
%    [MP_VALPOL_OUT, FLAG] = FF_VFI_AZ_VEC(MP_PARAMS, MP_SUPPORT,
%    MP_SUPPORT_GRAPH) also changing graphing options, see the
%    FF_GRAPH_GRID function for what key value paris can be specified.
%
%    see also FX_VFI_AZ_VEC, FF_VFI_AZ_LOOP, FF_VFI_AZ_BISEC_LOOP,
%    FF_VFI_AZ_BISEC_VEC, FF_VFI_AZ_MZOOM_LOOP, FF_VFI_AZ_MZOOM_VEC,
%    FF_GRAPH_GRID
%

%%
function [mp_valpol_out, flag] = ff_vfi_az_vec(varargin)

%% Set Default and Parse Inputs
if (~isempty(varargin))
    
    if (length(varargin) == 1)
        [mp_params_ext] = varargin{:};
    elseif (length(varargin) == 2)
        [mp_params_ext, mp_support_ext] = varargin{:};
    end
    
else
    close all
    
    mp_support_ext = containers.Map('KeyType','char', 'ValueType','any');
    mp_support_ext('bl_timer') = true;
    mp_support_ext('bl_print_params') = true; 
    mp_support_ext('bl_print_iterinfo') = true;     
    mp_support_ext('ls_ffcmd') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'};
    mp_support_ext('ls_ffsna') = {'ap'};
    mp_support_ext('ls_ffgrh') = {'v', 'ap', 'c', 'y', 'savefraccoh'};
    mp_support_ext('ls_store') = {'v', 'ap', 'c', 'y', 'coh'};
    mp_support_ext('ffsna_opt_it_row_n_keep') = 10;
    mp_support_ext('ffsna_opt_it_col_n_keep') = 9;

end

%% Default Model Parameters
% support_map
mp_params = containers.Map('KeyType','char', 'ValueType','any');
mp_params('fl_crra') = 1.5;
mp_params('fl_beta') = 0.95;

mp_params('fl_w') = 1.40;
mp_params('fl_r') = 0.04;

mp_params('fl_a_min') = 0;
mp_params('fl_a_max') = 50;
mp_params('it_a_n') = 100;
mp_params('st_grid_type') = 'grid_powerspace';

mp_params('fl_z_persist') = 0.80;
mp_params('fl_shk_std') = 0.20;
mp_params('it_z_n') = 7;

% override default support_map values
if (length(varargin)>=1)
    mp_params = [mp_params; mp_params_ext];
end

%% Parse mp_params
params_group = values(mp_params, {'fl_crra', 'fl_beta'});
[fl_crra, fl_beta] = params_group{:};
params_group = values(mp_params, {'fl_w', 'fl_r'});
[fl_w, fl_r] = params_group{:};
params_group = values(mp_params, {'fl_a_min', 'fl_a_max', 'it_a_n', 'st_grid_type'});
[fl_a_min, fl_a_max, it_a_n, st_grid_type] = params_group{:};
params_group = values(mp_params, {'fl_z_persist', 'fl_shk_std', 'it_z_n'});
[fl_z_persist, fl_shk_std, it_z_n] = params_group{:};

%% Generate A and Z Grids
% Same min and max and grid points
[ar_a] = ff_saveborr_grid(fl_a_min, fl_a_max, it_a_n, st_grid_type);
ar_a = ar_a';

% shock vector and transition, normalize mean exp(shk) to 1
[ar_z, mt_z_trans] = ffy_rouwenhorst(fl_z_persist, fl_shk_std, it_z_n, false);
% [ar_z, mt_z_trans] = ffy_tauchen(fl_z_persist, fl_shk_std, it_z_n, false);
% normalize mean of exp to 1, fl_shk_std does not shift mean.
ar_z_stationary = mt_z_trans^1000;
ar_z_stationary = ar_z_stationary(1,:);
fl_labor_agg = ar_z_stationary*exp(ar_z);
ar_z = exp(ar_z')/fl_labor_agg;

%% Default Support Parameters
% support_map
mp_support = containers.Map('KeyType','char', 'ValueType','any');

% Model Control
mp_support('fl_lowestc') = -1e10;

% Iteration Control
mp_support('it_maxiter_val') = 500;
mp_support('fl_tol_val') = 1e-5;

% printer various information
mp_support('bl_timer') = true;
mp_support('bl_print_params') = false; 
mp_support('bl_print_iterinfo') = false; 

% These names must match keys of mp_solu: v, ap, c, y, savefraccoh
% what outcomes to store in the mp_solu for export
mp_support('ls_slout') = {'v', 'ap', 'c', 'y', 'coh', 'savefraccoh'}; 
% outcome for ff_container_map_display
mp_support('ls_ffcmd') = {'ap'}; 
% outcome for ff_summ_nd_array
mp_support('ls_ffsna') = {}; 
% outcome for ff_graph_grid
mp_support('ls_ffgrh') = {}; 
% outcome for ff_summ_nd_array
mp_support('ffsna_opt_it_row_n_keep') = 10;
% outcome for ff_summ_nd_array
mp_support('ffsna_opt_it_col_n_keep') = 9; 

% override default support_map values
if (length(varargin)>=2 || isempty(varargin))
    mp_support = [mp_support; mp_support_ext];
end

% Parse mp_support
params_group = values(mp_support, {'fl_lowestc'});
[fl_lowestc] = params_group{:};
params_group = values(mp_support, {'it_maxiter_val', 'fl_tol_val'});
[it_maxiter_val, fl_tol_val] = params_group{:};
params_group = values(mp_support, {'bl_timer', 'bl_print_params', 'bl_print_iterinfo'});
[bl_timer, bl_print_params, bl_print_iterinfo] = params_group{:};
params_group = values(mp_support, ...
    {'ls_slout', 'ls_ffcmd', 'ls_ffsna', 'ls_ffgrh',...
    'ffsna_opt_it_row_n_keep', 'ffsna_opt_it_col_n_keep'});
[ls_slout, ls_ffcmd, ls_ffsna, ls_ffgrh,...
    ffsna_opt_it_row_n_keep, ffsna_opt_it_col_n_keep] = params_group{:};

%% Whether Additional Outcomes Should be Stored
% when state space are large, might not be a good idea to store all
% possible model output matrixes, but could be controlled with these if
% things should be outputed. If bl_store_more = true, will output store all
% additional possible outcomes if bl_vfi_store_all = true. Internally,
% which output becomes tabular or graphical controled by ls_ffcmd,
% ls_ffsna, and ls_ffgrh.

% If to store additional outcomes
cl_more = {'c', 'y', 'coh', 'savefraccoh'};
ar_find_slout = cell2mat(cellfun(@(m) find(strcmp(ls_slout, m)), cl_more, 'UniformOutput', false));
ar_find_ffcmd = cell2mat(cellfun(@(m) find(strcmp(ls_ffcmd, m)), cl_more, 'UniformOutput', false));
ar_find_ffsna = cell2mat(cellfun(@(m) find(strcmp(ls_ffsna, m)), cl_more, 'UniformOutput', false));
ar_find_ffgrh = cell2mat(cellfun(@(m) find(strcmp(ls_ffgrh, m)), cl_more, 'UniformOutput', false));
bl_store_more = false;
if (length(ar_find_slout) + length(ar_find_ffcmd) + length(ar_find_ffsna) + length(ar_find_ffgrh) >1)
    bl_store_more = true;
end

%% Initialize Matrix
mt_val_cur = zeros(length(ar_a),length(ar_z));
mt_val_lst = mt_val_cur;
mt_aprime_cur = zeros(length(ar_a),length(ar_z));
mt_aprime_lst = mt_aprime_cur;
mt_aprime_idx = zeros(length(ar_a),length(ar_z));
ar_val_diff_norm = zeros([it_maxiter_val, 1]);
ar_pol_diff_norm = zeros([it_maxiter_val, 1]);
mt_pol_perc_change = zeros([it_maxiter_val, length(ar_z)]);

if (bl_store_more)
    mt_c = zeros(length(ar_a),length(ar_z));
    mt_y = zeros(length(ar_a),length(ar_z));
    mt_coh = zeros(length(ar_a),length(ar_z));
end

%% Define Functions
f_util_log = @(c) log(c);
f_util_crra = @(c) (((c).^(1-fl_crra)-1)./(1-fl_crra));
f_y = @(z, b) (z*fl_w + b.*(fl_r));
f_coh = @(z, b) (z*fl_w + b.*(1+fl_r));
f_cons = @(z, b, bprime) (f_coh(z, b) - bprime);

%% Iterate and Dynamically Solve
if (bl_timer)
    tic
end

% initialize
fl_diff = 1;
it_iter = 0;

% After converge, one more iteration to store results
bl_continue = true;
bl_converged = false;

while bl_continue
    
    % A. Loop over endo and exo states, solve for ap(a,z)
    % loop 1: over exogenous states
    % incorporating these shocks into vectorization has high memory burden
    % but insignificant speed gains. Keeping this loop allows for large
    % number of shocks without overwhelming memory
    for it_z_ctr = 1:length(ar_z)
        
        % Current Shock
        fl_z = ar_z(it_z_ctr);
        
        % Consumption and u(c) only need to be evaluated once
        if (it_iter == 0)
            
            % Consumption: fl_z = 1 by 1, ar_a = 1 by N, ar_a' = N by 1
            % mt_c is N by N: matrix broadcasting, expand to matrix from arrays
            mt_c_a_ap = f_cons(fl_z, ar_a, ar_a');
            
            % EVAL current utility: N by N, f_util defined earlier
            % slightly faster to explicitly write function
            if (fl_crra == 1)
                mt_utility = f_util_log(mt_c_a_ap);
            else
                % slightly faster if write function here directly, but
                % speed gain is very small, more important to have single
                % location control of functions.
                mt_utility = f_util_crra(mt_c_a_ap);
            end
            
            % Eliminate Complex Numbers
            mt_it_c_valid_idx = (mt_c_a_ap <= 0);
            mt_utility(mt_it_c_valid_idx) = fl_lowestc;
            
            % Store in cells
            cl_u_c_store{it_z_ctr} = mt_utility;
            cl_c_valid_idx{it_z_ctr} = mt_it_c_valid_idx;
            
        end
        
        % f(z'|z), 1 by Z
        ar_z_trans_condi = mt_z_trans(it_z_ctr,:);
        
        % EVAL EV((A',K'),Z'|Z) = V((A',K'),Z') x p(z'|z)', (N by Z) x (Z by 1) = N by 1
        % Note: transpose ar_z_trans_condi from 1 by Z to Z by 1
        % Note: matrix multiply not dot multiply
        mt_evzp_condi_z = mt_val_lst * ar_z_trans_condi';
        
        % EVAL add on future utility, N by N + N by 1, broadcast again
        mt_utility = cl_u_c_store{it_z_ctr} + fl_beta*mt_evzp_condi_z;
        
        % Index update
        % using the method below is much faster than index replace
        % see <https://fanwangecon.github.io/M4Econ/support/speed/index/fs_subscript.html fs_subscript>
        mt_it_c_valid_idx = cl_c_valid_idx{it_z_ctr};
        mt_utility = mt_utility.*(~mt_it_c_valid_idx) + (fl_lowestc)*(mt_it_c_valid_idx);
        
        % Optimization: remember matlab is column major, rows must be
        % choices, columns must be states
        % <https://en.wikipedia.org/wiki/Row-_and_column-major_order COLUMN-MAJOR>
        % mt_utility is N by N, rows are choices, cols are states.
        [ar_opti_val1_z, ar_opti_idx_z] = max(mt_utility);
        mt_val_cur(:,it_z_ctr) = ar_opti_val1_z';
        mt_aprime_cur(:,it_z_ctr) = ar_a(ar_opti_idx_z);
    
        % Save Additional Results
        if bl_converged
            mt_aprime_idx(:,it_z_ctr) = ar_opti_idx_z;
            if (bl_store_more)
                mt_c(:,it_z_ctr) = f_cons(fl_z, ar_a, ar_a(ar_opti_idx_z));
                mt_y(:,it_z_ctr) = f_y(fl_z, ar_a);
                mt_coh(:,it_z_ctr) = f_coh(fl_z, ar_a);
            end            
        end
    end    
    
    % B. Various Continuous Conditions
    % Continuation Conditions:
    it_iter = it_iter + 1;
    fl_diff = norm(mt_val_cur-mt_val_lst);
    diff_pol = norm(mt_aprime_cur-mt_aprime_lst);
    
    % Difference across iterations
    if (bl_print_iterinfo)
        ar_val_diff_norm(it_iter) = fl_diff;
        ar_pol_diff_norm(it_iter) = diff_pol;
        mt_pol_perc_change(it_iter, :) = sum((mt_aprime_cur ~= mt_aprime_lst))/(length(ar_a));
    end
    
    % Update
    mt_val_lst = mt_val_cur;
    mt_aprime_lst = mt_aprime_cur;
    
    % Update Continue Criterion
    if bl_converged
        bl_continue = false;
    elseif(fl_diff <= fl_tol_val || it_iter >= it_maxiter_val)
        bl_converged = true;
    end
    
    % C. Print Iteration Record
    if(bl_print_iterinfo)
        disp(['ff_vfi_az_bisec_loop, it_iter:' num2str(it_iter) ...
            ', fl_diff:' num2str(fl_diff)]);
    end    
    
end


%% Convergence Results
it_iter_last = it_iter;
mt_val_cur = mt_val_lst;
mt_aprime = mt_aprime_lst;
if fl_diff <= fl_tol_val || it_iter>=it_maxiter_val
    if (it_iter>=it_maxiter_val)
        flag = 2;
    else
        flag = 1;
    end
else
    flag = 0;
end

if (bl_timer)
    toc
end

%% Results for Printing, and Graphing
mp_print_graph = containers.Map('KeyType','char', 'ValueType','any');
mp_print_graph('v') = mt_val_cur;
mp_print_graph('ap') = mt_aprime;
if (bl_store_more)
    mp_print_graph('c') = mt_c;
    mp_print_graph('y') = mt_y;
    mp_print_graph('coh') = mt_coh;
    mp_print_graph('savefraccoh') = mt_aprime./mt_coh;
end

%% Print Parameter Information
if (bl_print_params)    
    ff_container_map_display(mp_params);
    ff_container_map_display(mp_support);    
end

%% Show Value Function Convergence Information
if (bl_print_iterinfo)
    
    it_z_select = unique(round(linspace(1,length(ar_z), 7)));
    ar_z_select = ar_z(it_z_select);
    tb_valpol_alliter = array2table([ar_val_diff_norm(1:it_iter_last)';...
                                     ar_pol_diff_norm(1:it_iter_last)';...
                                     mt_pol_perc_change(1:it_iter_last,it_z_select)']');
    ar_st_col_zs = matlab.lang.makeValidName(strcat('z=', string(ar_z_select)));                                 
    cl_col_names = ['valgap', 'polgap', ar_st_col_zs];
    cl_row_names = strcat('iter=', string(1:it_iter_last));
    tb_valpol_alliter.Properties.VariableNames = cl_col_names;    
    tb_valpol_alliter.Properties.RowNames = cl_row_names;
    disp('xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx');
    disp('Value Function Iteration Per Iteration Changes');
    disp('xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx');
    disp('valgap = norm(mt_val - mt_val_cur): value function difference across iterations');
    disp('polgap = norm(mt_pol_a - mt_pol_a_cur): policy function difference across iterations');
    disp(['z1 = z1 perc change: sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n): percentage of state space'...
          ' points conditional on shock where the policy function is changing across iterations']);
        disp(tb_valpol_alliter);
    
end

%% ls_ffcmd summary
if (~isempty(ls_ffcmd))    
    mp_ffcmd = containers.Map(ls_ffcmd, values(mp_print_graph, ls_ffcmd));
    ff_container_map_display(mp_ffcmd, ffsna_opt_it_row_n_keep, ffsna_opt_it_col_n_keep);    
end

%% ls_ffsna summarize full
if (~isempty(ls_ffsna))
    
    % container map subseting
    mp_ffsna = containers.Map(ls_ffsna, values(mp_print_graph, ls_ffsna));
    
    % ff_summ_nd_array parameters
    it_aggd = 0;
    bl_row = 1;
    ar_permute = [2,1];
    ar_st_stats = ["mean"];
    bl_print_table = true;
    cl_mp_datasetdesc = {};
    cl_mp_datasetdesc{1} = containers.Map({'name', 'labval'}, {'a', ar_a});
    cl_mp_datasetdesc{2} = containers.Map({'name', 'labval'}, {'z', ar_z});
    
    % summarize 
    param_map_keys = keys(mp_ffsna);
    param_map_vals = values(mp_ffsna);
    for i = 1:length(mp_ffsna)
        st_mt_name = param_map_keys{i};
        mt_cur = param_map_vals{i};
        st_title = ['ff_vfi_az_vec, outcome=' st_mt_name];        
        ff_summ_nd_array(st_title, mt_cur, ...
            bl_print_table, ar_st_stats, it_aggd, bl_row, ...
            cl_mp_datasetdesc, ar_permute);        
    end
    
end

%% ls_ffgrh graph
if (~isempty(ls_ffgrh))

    % container map subseting
    mp_ffgrh = containers.Map(ls_ffgrh, values(mp_print_graph, ls_ffgrh));
    
    % container map settings
    mp_support_graph = containers.Map('KeyType', 'char', 'ValueType', 'any');
    mp_support_graph('cl_st_xtitle') = {'savings states, a'};
    mp_support_graph('st_legend_loc') = 'best';
    mp_support_graph('bl_graph_logy') = true; % do not log
    mp_support_graph('st_rowvar_name') = 'shock=';
    mp_support_graph('it_legend_select') = 5; % how many shock legends to show
    mp_support_graph('st_rounding') = '6.2f'; % format shock legend
    mp_support_graph('cl_colors') = 'jet'; % any predefined matlab colormap
    
    % Overide graph options here with external parameters
    if (length(varargin)>=3)
        mp_support_graph = [mp_support_graph; mp_support_ext];
    end
    
    % summarize 
    param_map_keys = keys(mp_ffgrh);
    param_map_vals = values(mp_ffgrh);
    for i = 1:length(mp_ffgrh)
        % Get matrix and key
        st_mt_name = param_map_keys{i};
        mt_cur = param_map_vals{i};
        
        % Update Title and Y label
        mp_support_graph('cl_st_graph_title') = {[st_mt_name '(a,z), savings state =x, shock state = color']};
        mp_support_graph('cl_st_ytitle') = {[st_mt_name '(a,z)']};
        
        % Call function
        ff_graph_grid(mt_cur', ar_z, ar_a, mp_support_graph);
    end
    
end

%% Store Results for Output
mp_valpol_out = containers.Map(ls_slout, values(mp_print_graph, ls_slout));

end


##### SOURCE END #####
--></body></html>